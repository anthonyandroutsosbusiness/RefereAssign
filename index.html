<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Referee Assignment System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom card style for compact fixture display */
        .fixture-card {
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
            cursor: default; 
        }
        
        .fixture-main-content {
            display: flex;
            align-items: center;
            flex-grow: 1;
            gap: 1.5rem; /* Space between sections */
            padding: 0.75rem 1rem;
        }
        .fixture-action-area {
            padding: 0.5rem 1rem;
            border-top: 1px solid #f3f4f6;
            background-color: #fff; 
        }

        /* Status colors */
        .status-open { border-left: 5px solid #34d399; } /* Green */
        .status-assigned { border-left: 5px solid #3b82f6; } /* Blue */
        .status-completed { border-left: 5px solid #9ca3af; } /* Gray */

        /* Night Shift Card */
        .night-shift-card {
            min-width: 280px;
            max-width: 350px;
            border: 1px solid #e5e7eb;
            background-color: #fff;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        /* Editing style */
        .editable-input {
            border: 1px solid #d1d5db;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem;
            margin-right: 0.5rem;
        }

    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Status Message Area -->
    <div id="status-area" class="fixed top-4 right-4 z-50"></div>

    <header class="mb-8">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Referee Dashboard</h1>
        <div id="user-info" class="text-gray-600">Loading user info...</div>
    </header>

    <!-- Admin Button Area -->
    <div id="admin-actions" class="mb-8 hidden">
        <div class="flex flex-wrap gap-3">
            <button onclick="addFixture()" class="px-4 py-2 bg-indigo-600 text-white text-sm font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                + Add 11s Fixture
            </button>
            <button onclick="addNightShiftBlock()" class="px-4 py-2 bg-yellow-600 text-white text-sm font-semibold rounded-lg hover:bg-yellow-700 transition duration-150 shadow-md">
                + Add Night Shift Block
            </button>
        </div>
    </div>
    
    <!-- NIGHT SHIFTS SECTION -->
    <div class="mb-12">
        <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2">5s and 7s Night Shifts</h2>
        <div id="night-shifts-container" class="flex flex-wrap gap-4 overflow-x-auto p-2">
            <!-- Night shift blocks will be rendered here -->
            <div class="text-gray-500 text-sm">Loading night shift blocks...</div>
        </div>
    </div>
    
    <!-- 11s FIXTURES SECTION -->
    <div class="mb-12">
        <h2 class="text-2xl font-bold text-gray-700 mb-4 border-b pb-2">11s Fixtures</h2>
        <div id="fixtures-container" class="space-y-4">
            <!-- Fixture cards will be rendered here -->
            <div class="text-gray-500 text-sm">Loading 11s fixtures...</div>
        </div>
    </div>


    <!-- Status Modal (Custom replacement for alert/confirm) -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-[100] hidden items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm">
            <h3 id="modal-title" class="text-lg font-semibold mb-3">Confirmation</h3>
            <p id="modal-message" class="text-gray-600 mb-4">Are you sure?</p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 text-sm font-medium rounded-lg text-gray-700 bg-gray-200 hover:bg-gray-300 transition">Cancel</button>
                <button id="modal-confirm" class="px-4 py-2 text-sm font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 transition">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            addDoc, 
            getDocs, 
            serverTimestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL CONSTANTS & VARIABLES ---
        setLogLevel('Debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const __initial_auth_token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firestore Collection Paths
        const FIRES_COLLECTION_PATH = `/artifacts/${appId}/public/data/fixtures`;
        const NIGHT_SHIFT_COLLECTION_PATH = `/artifacts/${appId}/public/data/night_shifts`;

        let app, db, auth;
        let userId = null;
        let userRole = 'ref'; // Default role
        let userName = 'Anonymous Ref';
        let isDbReady = false;
        let dbFixtures = [];
        let dbNightShifts = [];
        let editingFixtureId = null;

        // --- UTILITY FUNCTIONS ---

        /** Shows temporary status messages (like success/error). */
        function showStatus(type, message) {
            const container = document.getElementById('status-area');
            const colorMap = {
                success: 'bg-green-500',
                warning: 'bg-yellow-500',
                danger: 'bg-red-500'
            };
            
            const statusDiv = document.createElement('div');
            statusDiv.className = `${colorMap[type]} text-white p-3 mb-2 rounded-lg shadow-md transition-all duration-300`;
            statusDiv.textContent = message;

            container.prepend(statusDiv);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                statusDiv.remove();
            }, 5000);
        }

        /** Shows a custom modal dialog for confirmation actions. */
        function showCustomModal(title, message, onConfirm) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;

            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');

            // Clear previous event listeners
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            
            const newCancelBtn = cancelBtn.cloneNode(true);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

            modal.classList.remove('hidden');
            modal.classList.add('flex');

            newConfirmBtn.onclick = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                onConfirm();
            };

            newCancelBtn.onclick = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            };
        }


        // --- FIREBASE INITIALIZATION & AUTHENTICATION ---

        function initFirebase() {
            if (!firebaseConfig) {
                console.warn("Firebase config is missing. Operating in local-storage fallback mode.");
                isDbReady = false;
                loadLocalFixtures();
                loadLocalNightShifts();
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // Determine user role and name from Firestore user data (simplified for this app)
                        const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}/profile/data`);
                        const userDoc = await getDoc(userDocRef);
                        
                        if (userDoc.exists()) {
                            const data = userDoc.data();
                            userRole = data.role || 'ref';
                            userName = data.name || `User ${user.uid.substring(0, 8)}`;
                        } else {
                            // First time login, create a basic profile document
                            userRole = userId === 'admin_placeholder_uid' ? 'admin' : 'ref'; // Simple admin check
                            userName = `Ref ID: ${user.uid.substring(0, 8)}`;
                            await setDoc(userDocRef, { 
                                name: userName, 
                                role: userRole,
                                createdAt: serverTimestamp() 
                            }, { merge: true });
                        }
                    } else {
                        // Not authenticated, use anonymous access
                        userId = null;
                        userRole = 'ref';
                        userName = 'Anonymous Ref (Read-Only)';
                    }
                    updateUIBasedOnIdentity();
                    initFixtures(); // Start listening for fixtures after auth is ready
                    initNightShifts(); // Start listening for night shifts after auth is ready
                    isDbReady = true;

                });
                
                // Sign in using custom token or anonymously
                if (__initial_auth_token) {
                    signInWithCustomToken(auth, __initial_auth_token).catch(e => {
                        console.error("Custom token sign-in failed, signing in anonymously:", e);
                        signInAnonymously(auth);
                    });
                } else {
                    signInAnonymously(auth);
                }

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                isDbReady = false;
                loadLocalFixtures();
                loadLocalNightShifts();
            }
        }

        // --- LOCAL STORAGE FALLBACK FUNCTIONS (Simplified) ---
        // Note: For multi-user features like night shift approvals, local storage cannot replace Firestore.
        function loadLocalFixtures() {
            dbFixtures = JSON.parse(localStorage.getItem('localFixtures') || '[]');
            renderFixtures(dbFixtures);
        }

        function updateLocalFixture(id, updates) {
            let fixture = dbFixtures.find(f => f.id === id);
            if (fixture) {
                Object.assign(fixture, updates);
                localStorage.setItem('localFixtures', JSON.stringify(dbFixtures));
                renderFixtures(dbFixtures);
            }
        }
        
        function loadLocalNightShifts() {
            dbNightShifts = JSON.parse(localStorage.getItem('localNightShifts') || '[]');
            renderNightShifts(dbNightShifts);
        }

        function updateLocalNightShift(id, updates) {
            let shift = dbNightShifts.find(s => s.id === id);
            if (shift) {
                Object.assign(shift, updates);
                localStorage.setItem('localNightShifts', JSON.stringify(dbNightShifts));
                renderNightShifts(dbNightShifts);
            }
        }
        
        function deleteLocalFixture(id) {
            dbFixtures = dbFixtures.filter(f => f.id !== id);
            localStorage.setItem('localFixtures', JSON.stringify(dbFixtures));
            renderFixtures(dbFixtures);
        }
        
        function deleteLocalNightShift(id) {
            dbNightShifts = dbNightShifts.filter(s => s.id !== id);
            localStorage.setItem('localNightShifts', JSON.stringify(dbNightShifts));
            renderNightShifts(dbNightShifts);
        }

        // --- UI & DATA FUNCTIONS: 11s FIXTURES ---

        /** Initializes the real-time listener for 11s Fixtures. */
        function initFixtures() {
             if (isDbReady && db) {
                const fixturesQuery = collection(db, FIRES_COLLECTION_PATH);
                onSnapshot(fixturesQuery, (snapshot) => {
                    dbFixtures = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Sort fixtures by time string (e.g., "19:00" comes before "20:30")
                    dbFixtures.sort((a, b) => (a.time || '').localeCompare(b.time || ''));
                    renderFixtures(dbFixtures);
                }, (error) => {
                    console.error("Error listening to fixtures:", error);
                    // Fall back to local storage on read failure
                    isDbReady = false;
                    loadLocalFixtures();
                });
            } else {
                loadLocalFixtures();
            }
        }

        /** Renders the list of 11s fixtures. */
        function renderFixtures(fixtures) {
            const container = document.getElementById('fixtures-container');
            container.innerHTML = '';
            
            if (fixtures.length === 0) {
                 container.innerHTML = '<p class="text-gray-500 p-4 bg-white rounded-lg">No 11s fixtures scheduled for this week.</p>';
                 return;
            }

            fixtures.forEach(fixture => {
                const isAssigned = !!fixture.assignedRef;
                const statusClass = `status-${isAssigned ? 'assigned' : (fixture.status === 'completed' ? 'completed' : 'open')}`;
                
                // Check if the current fixture is being edited
                const isEditing = fixture.id === editingFixtureId;
                
                const card = document.createElement('div');
                card.id = `fixture-${fixture.id}`;
                card.className = `fixture-card bg-white rounded-lg overflow-hidden ${statusClass}`;

                const mainContentHTML = isEditing ? `
                    <div class="flex-grow flex flex-wrap gap-2 text-sm md:text-base">
                        <input type="time" id="edit-time-${fixture.id}" value="${fixture.time || ''}" class="editable-input w-20">
                        <input type="text" id="edit-ground-${fixture.id}" value="${fixture.ground || ''}" placeholder="Ground" class="editable-input flex-grow">
                        <input type="text" id="edit-pitch-${fixture.id}" value="${fixture.pitch || ''}" placeholder="Pitch" class="editable-input w-16">
                        <input type="text" id="edit-vs-${fixture.id}" value="${fixture.vs || ''}" placeholder="Opponent" class="editable-input flex-grow">
                    </div>
                ` : `
                    <div class="font-mono text-sm w-12 md:w-16 flex-shrink-0 text-gray-700">${fixture.time || 'TBD'}</div>
                    <div class="flex-grow">
                        <span class="font-semibold text-gray-800">${fixture.ground || 'N/A'} - ${fixture.pitch || 'PITCH'}</span>
                        <span class="text-gray-600 block text-sm">vs ${fixture.vs || 'Unknown Opponent'}</span>
                    </div>
                `;

                const refInfoHTML = isEditing ? 
                    `<span class="text-sm text-gray-500 w-28 md:w-36 text-right flex-shrink-0">Editing...</span>`
                    : `
                    <div class="text-sm w-28 md:w-36 text-right flex-shrink-0">
                        <span class="font-medium ${isAssigned ? 'text-blue-600' : 'text-green-600'}">
                            ${isAssigned ? (fixture.assignedRefName || 'Assigned') : 'OPEN'}
                        </span>
                        <span class="block text-xs text-gray-500">${fixture.status || 'open'}</span>
                    </div>
                `;
                
                const actionButton = (
                    userRole === 'admin' 
                        ? (isEditing ? 
                            `<button onclick="saveEditedFixture('${fixture.id}')" class="px-3 py-1 bg-green-500 text-white rounded-md text-xs hover:bg-green-600">Save</button>`
                            : `<button onclick="toggleEditFixture('${fixture.id}')" class="px-3 py-1 bg-yellow-500 text-white rounded-md text-xs hover:bg-yellow-600">Edit</button>`)
                        : (isAssigned && fixture.assignedRef === userId && fixture.status !== 'completed'
                            ? `<button onclick="unassign('${fixture.id}')" class="px-3 py-1 bg-yellow-500 text-white rounded-md text-xs hover:bg-yellow-600">Unassign</button>`
                            : (!isAssigned && fixture.status !== 'completed'
                                ? `<button onclick="volunteer('${fixture.id}')" class="px-3 py-1 bg-green-500 text-white rounded-md text-xs hover:bg-green-600">Volunteer</button>`
                                : `<button disabled class="px-3 py-1 bg-gray-300 text-gray-600 rounded-md text-xs">Closed</button>`
                            )
                        )
                );
                
                const adminDeleteButton = (userRole === 'admin' && !isEditing) 
                    ? `<button onclick="deleteFixture('${fixture.id}')" class="p-1 text-red-500 hover:text-red-700 ml-2" title="Delete Fixture">üóëÔ∏è</button>`
                    : '';
                
                const adminCancelButton = (userRole === 'admin' && isEditing) 
                    ? `<button onclick="toggleEditFixture(null)" class="px-3 py-1 bg-gray-400 text-white rounded-md text-xs hover:bg-gray-500 ml-2">Cancel</button>`
                    : '';

                card.innerHTML = `
                    <div class="fixture-main-content">
                        ${mainContentHTML}
                        ${refInfoHTML}
                    </div>
                    <div class="fixture-action-area flex justify-end items-center space-x-2">
                        ${actionButton}
                        ${adminCancelButton}
                        ${adminDeleteButton}
                    </div>
                `;
                
                container.appendChild(card);
            });
        }


        /** Allows Admin to edit fixture details in place. */
        window.toggleEditFixture = function(fixtureId) {
            // If currently editing and clicking the same button, cancel editing
            if (editingFixtureId === fixtureId) {
                editingFixtureId = null;
            } else {
                editingFixtureId = fixtureId;
            }
            renderFixtures(dbFixtures); // Re-render to show/hide input fields
        }

        /** Saves the edited fixture data to the database. */
        window.saveEditedFixture = async function(fixtureId) {
            if (userRole !== 'admin') return showStatus('danger', 'Only administrators can edit fixtures.');

            const time = document.getElementById(`edit-time-${fixtureId}`).value;
            const ground = document.getElementById(`edit-ground-${fixtureId}`).value;
            const pitch = document.getElementById(`edit-pitch-${fixtureId}`).value;
            const vs = document.getElementById(`edit-vs-${fixtureId}`).value;
            
            if (!time || !ground || !pitch) {
                 return showStatus('danger', 'Time, Ground, and Pitch are required fields.');
            }

            const updates = {
                time: time,
                ground: ground,
                pitch: pitch,
                vs: vs,
                updatedAt: serverTimestamp()
            };

            // --- FIREBASE PATH ---
            if (isDbReady && db) {
                const matchRef = doc(db, FIRES_COLLECTION_PATH, fixtureId);
                try {
                    await updateDoc(matchRef, updates);
                    editingFixtureId = null; // Exit edit mode
                    showStatus('success', 'Fixture updated successfully.');
                    // Snapshot listener will trigger renderFixtures
                    return;
                } catch(e) {
                    console.error("Save failed (Database):", e);
                    isDbReady = false;
                    showStatus('danger', 'Database write failed. Falling back to local storage update.');
                }
            }

            // --- LOCAL STORAGE PATH ---
            updateLocalFixture(fixtureId, { ...updates, updatedAt: new Date().getTime() });
            editingFixtureId = null; // Exit edit mode
            showStatus('warning', 'Fixture updated locally.');
        }


        /** Deletes a fixture document from the database. (Admin only) */
        window.deleteFixture = function(fixtureId) {
            if (userRole !== 'admin') return showStatus('danger', 'Only administrators can delete fixtures.');
            
            showCustomModal("Confirm Deletion", "Are you sure you want to permanently delete this 11s fixture? This action cannot be undone.", async () => {
                
                // --- FIREBASE PATH ---
                if (isDbReady && db) {
                    const matchRef = doc(db, FIRES_COLLECTION_PATH, fixtureId);
                    try {
                        await deleteDoc(matchRef);
                        showStatus('warning', 'Fixture deleted successfully.');
                        return;
                    } catch(e) {
                        console.error("Delete failed (Database):", e);
                        isDbReady = false;
                        showStatus('danger', 'Database write failed. Falling back to local storage update.');
                    }
                }

                // --- LOCAL STORAGE PATH ---
                deleteLocalFixture(fixtureId);
                showStatus('warning', 'Fixture deleted locally.');
            });
        }
        
        /** Adds a new default fixture. (Admin only) */
        window.addFixture = async function() {
            if (userRole !== 'admin') return showStatus('danger', 'Only administrators can add fixtures.');
            
            const newFixture = {
                time: '20:00',
                ground: 'New Ground',
                pitch: 'PITCH X',
                vs: 'New Opponent',
                status: 'open',
                assignedRef: null,
                assignedRefName: null,
                createdAt: serverTimestamp()
            };

            // --- FIREBASE PATH ---
            if (isDbReady && db) {
                try {
                    await addDoc(collection(db, FIRES_COLLECTION_PATH), newFixture);
                    showStatus('success', 'New 11s fixture added.');
                    return;
                } catch(e) {
                    console.error("Add failed (Database):", e);
                    isDbReady = false;
                    showStatus('danger', 'Database write failed.');
                }
            }
            
            // --- LOCAL STORAGE PATH ---
            const localFixture = { 
                id: Date.now().toString(), // Use timestamp as ID for local
                ...newFixture, 
                createdAt: new Date().getTime() 
            };
            dbFixtures.push(localFixture);
            dbFixtures.sort((a, b) => a.time.localeCompare(b.time));
            localStorage.setItem('localFixtures', JSON.stringify(dbFixtures));
            renderFixtures(dbFixtures);
            showStatus('warning', 'New 11s fixture added locally.');
        }

        /** Volunteer for a 11s fixture. */
        window.volunteer = async function(matchId) {
            if (!userId) return showStatus('danger', 'You must be signed in to volunteer.');

            const updates = {
                assignedRef: userId,
                assignedRefName: userName,
                status: 'assigned',
                updatedAt: serverTimestamp()
            };

            // --- FIREBASE PATH ---
            if (isDbReady && db) {
                const matchRef = doc(db, FIRES_COLLECTION_PATH, matchId);
                try {
                    await updateDoc(matchRef, updates);
                    showStatus('success', `You have volunteered for the match!`);
                    return;
                } catch(e) {
                    console.error("Volunteer failed (Database):", e);
                    isDbReady = false;
                    showStatus('danger', 'Database write failed. Falling back to local storage update.');
                }
            }

            // --- LOCAL STORAGE PATH ---
            updateLocalFixture(matchId, { ...updates, updatedAt: new Date().getTime() });
            showStatus('warning', 'You have volunteered for the match locally.');
        }

        /** Unassign from a 11s fixture. */
        window.unassign = async function(matchId) {
             const fixture = dbFixtures.find(f => f.id === matchId);
             if (!fixture) return showStatus('danger', 'Match not found.');
             
             // Check permission: must be the assigned ref or an admin
             if (fixture.assignedRef !== userId && userRole !== 'admin') return showStatus('danger', 'You can only unassign yourself or be an administrator to clear the assignment.');
            
             const updates = {
                assignedRef: null,
                assignedRefName: null,
                status: 'open',
                updatedAt: serverTimestamp()
             };

             // --- FIREBASE PATH ---
             if (isDbReady && db) {
                 const matchRef = doc(db, FIRES_COLLECTION_PATH, matchId);
                 try {
                     await updateDoc(matchRef, updates);
                     showStatus('warning', 'Assignment cleared. Match is now open for volunteering.');
                     return;
                 } catch(e) {
                     console.error("Unassign failed (Database):", e);
                     isDbReady = false;
                     showStatus('danger', 'Database write failed. Falling back to local storage update.');
                 }
             }

             // --- LOCAL STORAGE PATH ---
             updateLocalFixture(matchId, { ...updates, updatedAt: new Date().getTime() });
             showStatus('warning', 'Assignment cleared locally.');
        }

        
        // --- UI & DATA FUNCTIONS: NIGHT SHIFTS ---

        /** Initializes the real-time listener for Night Shifts. */
        function initNightShifts() {
             if (isDbReady && db) {
                const shiftsQuery = collection(db, NIGHT_SHIFT_COLLECTION_PATH);
                onSnapshot(shiftsQuery, (snapshot) => {
                    dbNightShifts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderNightShifts(dbNightShifts);
                }, (error) => {
                    console.error("Error listening to night shifts:", error);
                    // Fall back to local storage on read failure
                    isDbReady = false;
                    loadLocalNightShifts();
                });
            } else {
                loadLocalNightShifts();
            }
        }

        /** Renders the night shift blocks. */
        function renderNightShifts(shifts) {
            const container = document.getElementById('night-shifts-container');
            container.innerHTML = '';
            
            if (shifts.length === 0) {
                 container.innerHTML = '<p class="text-gray-500 p-4 bg-white rounded-lg">No 5s/7s Night Shifts scheduled for this week.</p>';
                 return;
            }

            shifts.forEach(shift => {
                const volunteerRefs = shift.volunteerRefs || [];
                const max = shift.maxApprovals || 6;
                const approvedRefs = volunteerRefs.filter(r => r.status === 'approved');
                const pendingRefs = volunteerRefs.filter(r => r.status === 'pending');
                const userVolunteered = volunteerRefs.some(r => r.id === userId);
                const isApproved = volunteerRefs.some(r => r.id === userId && r.status === 'approved');
                const isFull = approvedRefs.length >= max;

                const card = document.createElement('div');
                card.id = `night-shift-${shift.id}`;
                card.className = 'night-shift-card flex-shrink-0';
                
                // Format: Ground Name / Pitch
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3 border-b pb-2">
                        <h4 class="text-lg font-semibold text-gray-800">${shift.groundName || 'Unknown Ground'}</h4>
                        <span class="text-xs font-bold px-2 py-1 rounded-full ${shift.format === '7s' ? 'bg-indigo-100 text-indigo-800' : 'bg-green-100 text-green-800'}">
                            ${shift.format || 'N/A'}
                        </span>
                    </div>

                    <p class="text-sm text-gray-600 mb-4">Pitch: <span class="font-medium">${shift.pitch || 'N/A'}</span></p>

                    <!-- Status/Volunteers -->
                    <div class="mb-4">
                        <p class="text-sm font-medium text-gray-700 mb-1">Referees Approved (${approvedRefs.length}/${max}):</p>
                        <ul class="text-xs space-y-1 pl-3">
                            ${approvedRefs.map(r => `<li class="text-blue-600 font-medium list-disc">${r.name}</li>`).join('') || '<li class="text-gray-500">None Approved yet.</li>'}
                        </ul>
                        ${pendingRefs.length > 0 && userRole === 'admin' ? 
                            `<p class="text-xs mt-2 text-yellow-700 font-medium">Pending: ${pendingRefs.length}</p>` : ''
                        }
                    </div>
                    
                    <!-- Action Area (Ref) -->
                    <div class="flex justify-between items-center space-x-2">
                        ${userRole === 'ref' ? `
                            ${isApproved 
                                ? `<button class="px-3 py-1 bg-blue-600 text-white rounded-md text-xs" disabled>Approved!</button>`
                                : (userVolunteered 
                                    ? `<button onclick="unvolunteerForNightShift('${shift.id}')" class="px-3 py-1 bg-yellow-500 text-white rounded-md text-xs hover:bg-yellow-600">Cancel Request</button>`
                                    : (isFull 
                                        ? `<button class="px-3 py-1 bg-gray-400 text-white rounded-md text-xs" disabled>Full</button>`
                                        : `<button onclick="volunteerForNightShift('${shift.id}')" class="px-3 py-1 bg-green-500 text-white rounded-md text-xs hover:bg-green-600">Volunteer</button>`)
                                )
                            }
                        ` : ''}

                        <!-- Action Area (Admin) -->
                        ${userRole === 'admin' ? `
                            <div class="flex flex-col space-y-2 w-full">
                                <span class="text-xs font-semibold text-gray-700">Manage Volunteers:</span>
                                ${pendingRefs.map(r => `
                                    <div class="flex items-center justify-between text-xs p-1 bg-gray-50 rounded">
                                        <span class="truncate">${r.name}</span>
                                        <div>
                                            <button onclick="processNightShiftVolunteer('${shift.id}', '${r.id}', 'approve')" class="text-green-600 hover:text-green-800 mx-1">‚úì</button>
                                            <button onclick="processNightShiftVolunteer('${shift.id}', '${r.id}', 'reject')" class="text-red-600 hover:text-red-800 mx-1">‚úó</button>
                                        </div>
                                    </div>
                                `).join('') || '<span class="text-xs text-gray-500">No pending requests.</span>'}
                                
                                <button onclick="removeNightShiftBlock('${shift.id}')" class="px-3 py-1 mt-3 bg-red-500 text-white rounded-md text-xs hover:bg-red-600">Remove Block</button>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                container.appendChild(card);
            });
        }
        
        /** Ref volunteers for a night shift block. */
        window.volunteerForNightShift = async function(shiftId) {
            if (!userId) return showStatus('danger', 'You must be signed in to volunteer.');
            
            const shift = dbNightShifts.find(s => s.id === shiftId);
            if (!shift) return showStatus('danger', 'Shift block not found.');
            
            const volunteerRefs = shift.volunteerRefs || [];
            if (volunteerRefs.some(r => r.id === userId)) {
                return showStatus('warning', 'You have already requested this shift.');
            }

            const newVolunteer = { id: userId, name: userName, status: 'pending' };
            const newRefs = [...volunteerRefs, newVolunteer];
            
            // --- FIREBASE PATH ---
            if (isDbReady && db) {
                const shiftRef = doc(db, NIGHT_SHIFT_COLLECTION_PATH, shiftId);
                try {
                    await updateDoc(shiftRef, { volunteerRefs: newRefs, updatedAt: serverTimestamp() });
                    showStatus('success', 'Night shift volunteer request sent for admin approval.');
                    return;
                } catch(e) {
                    console.error("Volunteer failed (Database):", e);
                    isDbReady = false;
                    showStatus('danger', 'Database write failed. Falling back to local storage update.');
                }
            }
            
            // --- LOCAL STORAGE PATH ---
            // Local storage is difficult for multi-user status; just update array
            updateLocalNightShift(shiftId, { volunteerRefs: newRefs, updatedAt: new Date().getTime() });
            showStatus('warning', 'Night shift volunteer request sent locally (needs admin approval in the app).');
        }

        /** Ref cancels their night shift volunteer request. */
        window.unvolunteerForNightShift = async function(shiftId) {
            if (!userId) return showStatus('danger', 'You must be signed in.');

            const shift = dbNightShifts.find(s => s.id === shiftId);
            if (!shift) return showStatus('danger', 'Shift block not found.');
            
            const newRefs = (shift.volunteerRefs || []).filter(r => r.id !== userId);

            // --- FIREBASE PATH ---
            if (isDbReady && db) {
                const shiftRef = doc(db, NIGHT_SHIFT_COLLECTION_PATH, shiftId);
                try {
                    await updateDoc(shiftRef, { volunteerRefs: newRefs, updatedAt: serverTimestamp() });
                    showStatus('warning', 'Night shift volunteer request cancelled.');
                    return;
                } catch(e) {
                    console.error("Unvolunteer failed (Database):", e);
                    isDbReady = false;
                    showStatus('danger', 'Database write failed. Falling back to local storage update.');
                }
            }

            // --- LOCAL STORAGE PATH ---
            updateLocalNightShift(shiftId, { volunteerRefs: newRefs, updatedAt: new Date().getTime() });
            showStatus('warning', 'Night shift volunteer request cancelled locally.');
        }

        /** Admin approves or rejects a night shift volunteer. */
        window.processNightShiftVolunteer = async function(shiftId, refId, action) {
            if (userRole !== 'admin') return showStatus('danger', 'Only administrators can approve volunteers.');
            
            const shift = dbNightShifts.find(s => s.id === shiftId);
            if (!shift) return showStatus('danger', 'Shift block not found.');

            let volunteerRefs = shift.volunteerRefs || [];
            const refToUpdate = volunteerRefs.find(r => r.id === refId);
            if (!refToUpdate) return showStatus('danger', 'Referee request not found.');

            const max = shift.maxApprovals || 6;
            const approvedRefsCount = volunteerRefs.filter(r => r.status === 'approved').length;

            if (action === 'approve') {
                if (approvedRefsCount >= max) {
                    return showStatus('danger', `Cannot approve: Maximum of ${max} approvals reached.`);
                }
                refToUpdate.status = 'approved';
                showStatus('success', `${refToUpdate.name} approved for the shift!`);
            } else if (action === 'reject') {
                // Remove the ref entirely on reject
                volunteerRefs = volunteerRefs.filter(r => r.id !== refId);
                showStatus('warning', `${refToUpdate.name}'s request rejected and removed.`);
            } else {
                 return showStatus('danger', 'Invalid action.');
            }
            
            // --- FIREBASE PATH ---
            if (isDbReady && db) {
                const shiftRef = doc(db, NIGHT_SHIFT_COLLECTION_PATH, shiftId);
                try {
                    await updateDoc(shiftRef, { volunteerRefs: volunteerRefs, updatedAt: serverTimestamp() });
                    return;
                } catch(e) {
                    console.error("Approval failed (Database):", e);
                    isDbReady = false;
                    showStatus('danger', 'Database write failed. Falling back to local storage update.');
                }
            }

            // --- LOCAL STORAGE PATH ---
            updateLocalNightShift(shiftId, { volunteerRefs: volunteerRefs, updatedAt: new Date().getTime() });
        }


        /** Admin adds a new default night shift block. */
        window.addNightShiftBlock = async function() {
            if (userRole !== 'admin') return showStatus('danger', 'Only administrators can add night shift blocks.');

            const newBlock = {
                groundName: 'NIGHT SHIFT VENUE',
                pitch: 'PITCH A',
                format: '5s',
                maxApprovals: 6,
                volunteerRefs: [],
                createdAt: serverTimestamp()
            };

            // --- FIREBASE PATH ---
            if (isDbReady && db) {
                try {
                    await addDoc(collection(db, NIGHT_SHIFT_COLLECTION_PATH), newBlock);
                    showStatus('success', 'New Night Shift block added.');
                    return;
                } catch(e) {
                    console.error("Add failed (Database):", e);
                    isDbReady = false;
                    showStatus('danger', 'Database write failed.');
                }
            }
            
            // --- LOCAL STORAGE PATH ---
            const localBlock = { 
                id: Date.now().toString(), // Use timestamp as ID for local
                ...newBlock, 
                createdAt: new Date().getTime() 
            };
            dbNightShifts.push(localBlock);
            localStorage.setItem('localNightShifts', JSON.stringify(dbNightShifts));
            renderNightShifts(dbNightShifts);
            showStatus('warning', 'New Night Shift block added locally.');
        }

        /** Admin removes a night shift block for the week. (Admin only) */
        window.removeNightShiftBlock = function(shiftId) {
             if (userRole !== 'admin') return showStatus('danger', 'Only administrators can remove blocks.');
            
             showCustomModal("Confirm Removal", "Are you sure you want to remove this Night Shift block for this week? This action cannot be undone.", async () => {
                
                // --- FIREBASE PATH ---
                if (isDbReady && db) {
                    const shiftRef = doc(db, NIGHT_SHIFT_COLLECTION_PATH, shiftId);
                    try {
                        await deleteDoc(shiftRef);
                        showStatus('warning', 'Night Shift block removed successfully.');
                        return;
                    } catch(e) {
                        console.error("Remove failed (Database):", e);
                        isDbReady = false;
                        showStatus('danger', 'Database write failed. Falling back to local storage update.');
                    }
                }

                // --- LOCAL STORAGE PATH ---
                deleteLocalNightShift(shiftId);
                showStatus('warning', 'Night Shift block removed locally.');
            });
        }


        // --- APPLICATION FLOW ---

        /** Updates UI elements based on the current user identity. */
        function updateUIBasedOnIdentity() {
            const userInfoElement = document.getElementById('user-info');
            userInfoElement.innerHTML = `Signed in as <span class="font-semibold">${userName}</span> (${userRole.toUpperCase()})`;
            
            const adminActions = document.getElementById('admin-actions');
            if (userRole === 'admin') {
                adminActions.classList.remove('hidden');
            } else {
                adminActions.classList.add('hidden');
            }
            
            renderFixtures(dbFixtures);
            renderNightShifts(dbNightShifts);
        }

        /** Master function to start the app logic. */
        function startApp() {
            updateUIBasedOnIdentity();
            initFirebase();
        }

        startApp();
    </script>
</body>
</html>
