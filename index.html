<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>Weekly Referee Assignment System</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ADDED: Tailwind config to extend colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#1e40af', // A deep blue
                        'secondary-gray': '#f3f4f6', // Light gray background
                        'accent-yellow': '#facc15', // Bright yellow for admin buttons
                        'status-open': '#10b981',      /* Green */
                        'status-assigned': '#3b82f6',  /* Blue */
                        'status-volunteered': '#f59e0b', /* Amber */
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .fixture-card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .admin-section {
            background-color: #ffe0e0;
            border: 2px solid #ef4444;
        }

        /* MODIFIED: Styles for new floating/minimizable identity box */
        #user-control-panel {
            position: fixed; /* CHANGED from sticky/float */
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            transition: all 0.3s ease-in-out;
            min-width: 280px;
            background: #ffffff;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            border-top: 4px solid #dc2626; /* Kept red border */
        }
        
        /* Minimized state styles (NEW) */
        .minimized {
            padding: 0.75rem 1rem !important;
            width: auto; /* Fit content */
            max-width: fit-content;
            cursor: pointer;
        }
        .minimized #expanded-content {
            display: none !important;
        }
        #minimized-content {
            display: none;
        }
        .minimized #minimized-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        /* General button style (NEW) */
        .action-button {
            transition: background-color 0.2s, transform 0.2s;
            font-weight: 600;
            border-radius: 0.5rem;
            padding: 0.6rem 1rem;
            text-align: center;
            border: none;
            cursor: pointer;
        }
        .action-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        .action-button:active {
            transform: translateY(1px);
        }
        
        /* Volunteered state for shifts (NEW) */
        .ref-shift-btn.volunteered {
            background-color: #10b981; /* status-open */
            border-color: #10b981;
            color: white;
            opacity: 1;
        }
        .ref-shift-btn.volunteered:hover {
             background-color: #059669;
        }

        /* Modal Backdrop (Unchanged) */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 50;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0; /* NEW for transition */
            transition: opacity 0.2s ease-in-out; /* NEW for transition */
        }
        /* NEW */
        .modal-backdrop.show {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            max-width: 90vw;
            width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: all 0.2s ease;
        }
        .modal-backdrop.show .modal-content {
            transform: scale(1);
        }

        /* Responsive adjustments for layout (Unchanged) */
        @media (min-width: 640px) {
            /* MODIFIED: Make admin cards clickable */
            .fixture-card.admin-clickable {
                cursor: pointer;
            }
            .fixture-card.admin-clickable:hover {
                box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.15), 0 2px 6px 0 rgba(0, 0, 0, 0.1);
                transform: translateY(-1px);
            }
            /* REMOVED: conflicting flex rules */
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <!-- Status Message Area (Unchanged) -->
    <div id="status-message" class="fixed top-4 left-1/2 -translate-x-1/2 p-3 rounded-xl shadow-xl z-50 hidden transition-all duration-300 transform" style="max-width: 90vw;"></div>

    <!-- MODIFIED: Right-Side Auth & Admin Panel (Now floating, minimizable) -->
    <div id="user-control-panel" class="shadow-xl" onclick="window.toggleIdentityBox(event)">
        
        <!-- Minimized View (NEW) -->
        <div id="minimized-content" class="flex items-center space-x-3 w-full">
            <svg class="w-6 h-6 text-red-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span id="minimized-name-display" class="text-red-600 font-semibold truncate flex-grow">Log In</span>
            <button onclick="event.stopPropagation(); clearIdentity();" class="text-gray-500 hover:text-red-700 text-xs font-semibold ml-2 flex-shrink-0">Logout</button>
        </div>

        <!-- Expanded View (MODIFIED) -->
        <div id="expanded-content" class="w-full space-y-4">
            <h2 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">My Identity</h2>
            
            <!-- Identity Input Form (Unchanged) -->
            <div id="identity-form" class="space-y-3">
                <h3 class="font-bold text-lg text-gray-700">Referee Login</h3>
                <input type="text" id="referee-name-input" placeholder="Enter Your Full Name (e.g. Ref1)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                <button onclick="handleRefereeLogin()" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md">
                    Login as Referee
                </button>
                <button onclick="showAdminLoginForm()" class="w-full text-sm text-red-600 hover:text-red-700 p-2">
                    Admin Login
                </button>
            </div>

            <!-- Admin Login Form (Unchanged) -->
            <div id="admin-login-form" class="space-y-3 hidden">
                <h3 class="font-bold text-lg text-red-700">Admin Login</h3>
                <input type="email" id="admin-email" value="admin@betterfootball.co.nz" placeholder="Email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                <input type="password" id="admin-password" value="password" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                <button onclick="handleAdminLogin()" class="w-full bg-red-600 text-white p-3 rounded-lg font-semibold hover:bg-red-700 transition duration-150 shadow-md">
                    Login as Admin
                </button>
                <button onclick="showRefereeLoginForm()" class="w-full text-sm text-gray-600 hover:text-gray-700 p-2">
                    Back to Referee Login
                </button>
            </div>

            <!-- Identity Display (Unchanged) -->
            <div id="identity-display" class="hidden">
                <p class="mb-2 text-sm"><span class="font-semibold text-gray-700">Logged In As:</span> <span id="display-ref-name" class="font-bold text-lg text-red-600"></span></p>
                <p class="mb-2 text-sm"><span class="font-semibold text-gray-700">Role:</span> <span id="display-role" class="font-bold"></span></p>
                <button onclick="clearIdentity()" class="text-xs text-gray-500 hover:text-red-500">Logout</button>
            </div>

            <!-- Admin Data Loading Panel (REMOVED from here) -->
            
            <!-- Admin Manage Button (NEW) -->
            <button id="admin-manage-button-expanded" onclick="event.stopPropagation(); window.toggleAdminModal();" class="action-button w-full bg-accent-yellow text-gray-900 py-2 rounded-lg font-semibold hidden">
                Admin: Manage Fixtures
            </button>
        </div>
    </div>
    
    <!-- Main Content Grid (MODIFIED: Added app-container and hidden) -->
    <main class="w-full max-w-4xl mx-auto sm:mr-96 hidden" id="app-container">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">Weekly Match Assignments</h1>
            <p id="ref-greeting" class="text-xl text-gray-600">Please log in to view the schedule.</p>
        </header>

        <!-- Referee Tools Area (Voting, Volunteering, Schedule) (NEW) -->
        <div id="ref-tools-area" class="bg-white rounded-xl shadow-lg border border-indigo-600/20 mb-8 p-6 hidden">
            <h2 class="text-2xl font-bold text-indigo-600 mb-4 border-b pb-2">Referee Collaborative Tools</h2>

            <!-- 5s/7s Voting -->
            <div class="mb-6 border-b pb-4 border-indigo-600/20">
                <h3 class="text-xl font-semibold text-gray-800 mb-3">Night Format Vote</h3>
                <div class="flex flex-wrap gap-4 items-center">
                    <button onclick="window.handleVote('5s')" class="action-button bg-indigo-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-indigo-700">
                        Vote for 5s Night
                    </button>
                    <button onclick="window.handleVote('7s')" class="action-button bg-indigo-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-indigo-700">
                        Vote for 7s Night
                    </button>
                    <span id="vote-counts" class="text-sm font-medium p-2 rounded-md bg-gray-100 border border-gray-300">Votes: ...</span>
                    
                    <!-- My Schedule Button (NEW) -->
                    <button onclick="window.showRefSchedule()" class="action-button bg-accent-yellow text-gray-900 py-2 px-4 rounded-lg font-semibold hover:bg-yellow-500 transition md:ml-auto">
                        My Approved Schedule
                    </button>
                </div>
            </div>

            <!-- Volunteering Shifts -->
            <div>
                <h3 class="text-xl font-semibold text-gray-800 mb-3">Volunteer for Shifts</h3>
                <div id="volunteer-shifts-list" class="mt-4 flex flex-wrap gap-2">
                    <!-- Shift buttons rendered by JS -->
                </div>
            </div>
        </div>
        
        <!-- Admin Tools Button (Outside Identity Box) (NEW) -->
        <div class="text-center mb-6">
             <button id="admin-manage-button-main" onclick="window.toggleAdminModal()" class="action-button bg-accent-yellow text-gray-900 py-2 px-6 rounded-lg font-semibold hover:bg-yellow-500 hidden">
                Admin: Manage Fixtures
            </button>
        </div>
        
        <!-- Upcoming Fixtures (Unchanged) -->
        <h2 class="text-2xl font-bold text-gray-700 border-b pb-2 mb-4">Upcoming Schedule (11s)</h2>
        <div id="upcoming-fixtures-list" class="space-y-6">
            <div id="loading-indicator" class="text-center text-gray-500 py-10">
                <svg class="animate-spin h-8 w-8 text-gray-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-3" id="loading-text">Connecting to database...</p>
            </div>
        </div>

    </main>
    
    <!-- Admin Fixture Management Modal (NEW) -->
    <div id="admin-modal" class="modal-backdrop" onclick="window.toggleAdminModal()">
        <div class="modal-content bg-white w-full max-w-lg space-y-4 rounded-xl p-6 shadow-2xl" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-bold text-red-600 border-b pb-2">Manage 11s Fixtures</h2>
            <p class="text-sm text-gray-600">Paste the **EXACT** vertical schedule below. *Fixtures with 'bye' will be skipped.* This will **replace** existing 11s data.</p>
            <textarea id="fixtures-paste-area" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="04 Nov 2025&#10;Chur Chicknes&#10;vs&#10;Frothers FC..."></textarea>
            
            <div class="flex justify-between space-x-2">
                <button onclick="window.clearAllFixtures()" class="action-button bg-gray-700 text-white py-2 px-4 rounded-lg font-semibold hover:bg-gray-800 flex-1">
                    Clear ALL 11s Fixtures
                </button>
                <button onclick="window.parseAndLoadFixtures()" class="action-button bg-red-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-700 flex-1">
                    Upload & Replace Fixtures
                </button>
            </div>
            <button onclick="window.toggleAdminModal()" class="action-button w-full bg-gray-200 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300 mt-2">
                Close
            </button>
        </div>
    </div>
    
    <!-- Referee Schedule Modal (NEW) -->
    <div id="schedule-modal" class="modal-backdrop" onclick="window.closeScheduleModal()">
        <div class="modal-content bg-white w-full max-w-lg space-y-4 rounded-xl p-6 shadow-2xl" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-bold text-indigo-600 border-b pb-2">My Approved Schedule</h2>
            <p class="text-sm text-gray-600">The list of fixtures and night shifts you have been assigned by the Admin.</p>
            
            <div id="schedule-list" class="max-h-80 overflow-y-auto border border-gray-200 rounded-lg p-3">
                <!-- Schedule items rendered by JS -->
            </div>
            
            <button onclick="window.closeScheduleModal()" class="action-button w-full bg-gray-200 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300 mt-2">
                Close
            </button>
        </div>
    </div>

    <!-- Admin Assignment Modal (MODIFIED: Added Quick Edit) -->
    <div id="admin-assignment-modal-backdrop" class="modal-backdrop transition-opacity duration-300" onclick="window.closeAssignmentModal()">
        <div id="admin-assignment-modal-content" class="modal-content bg-white p-6 rounded-xl shadow-2xl" onclick="event.stopPropagation()">
            <h3 class="text-2xl font-bold text-red-600 border-b pb-2 mb-4" id="modal-match-title"></h3>
            <p class="text-sm text-gray-600 mb-4" id="modal-match-details"></p>

            <form id="assignment-form" onsubmit="return false;" class="space-y-3">
                <p class="font-semibold text-gray-700">Select Referee to Assign:</p>
                <div id="volunteer-list-container" class="bg-gray-100 p-3 rounded-lg max-h-48 overflow-y-auto space-y-2 border">
                    <!-- Volunteer radio buttons will be inserted here -->
                </div>
                <input type="hidden" id="modal-match-id">
                <div class="flex justify-end pt-4 space-x-3">
                    <button type="submit" onclick="handleFinalAssignment()" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition" disabled id="assign-button">
                        Confirm Assignment
                    </button>
                </div>
            </form>
            
            <!-- Quick Edit Form (NEW) -->
            <hr class="my-4">
            <div>
                 <h3 class="text-lg font-semibold text-gray-800">Quick Edit Fixture</h3>
                 <form id="quick-edit-form" onsubmit="event.preventDefault(); window.handleQuickEdit();" class="space-y-2 mt-2">
                     <input type="hidden" id="edit-match-id">
                     <div>
                         <label for="edit-time" class="block text-xs font-medium text-gray-600">Time (e.g., 6:00pm)</label>
                         <input type="text" id="edit-time" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                     </div>
                     <div>
                         <label for="edit-location" class="block text-xs font-medium text-gray-600">Venue (e.g., St Pats)</label>
                         <input type="text" id="edit-location" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                     </div>
                      <div>
                         <label for="edit-pitch" class="block text-xs font-medium text-gray-600">Pitch (e.g., 1)</label>
                         <input type="text" id="edit-pitch" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
                     </div>
                     <button type="submit" class="action-button w-full bg-accent-yellow text-gray-900 py-2 px-4 rounded-lg font-semibold hover:bg-yellow-500 mt-2">
                        Save Changes
                    </button>
                 </form>
            </div>
            
            <button onclick="window.closeAssignmentModal()" class="action-button w-full bg-gray-200 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300 mt-4">
                Close
            </button>
        </div>
    </div>


    <!-- Firebase Imports and Script -->
    <script type="module">
        // --- GLOBAL SETUP & CONFIG ACCESS ---
        let rawFirebaseConfig = {};
        try {
            const configString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            rawFirebaseConfig = JSON.parse(configString);
        } catch (e) {
            console.error("CRITICAL ERROR: Failed to parse __firebase_config.", e);
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Configuration Constants
        const ADMIN_EMAIL = 'admin@betterfootball.co.nz';
        const ADMIN_PASSWORD = 'password';
        
        // MODIFIED: Role definitions
        const ADMIN_NAME = 'Admin'; // Use 'Admin' to match your request
        const REF_NAMES = ['Ref1', 'Ref2', 'Ref3']; // Add more names as needed
        
        const FIRES_COLLECTION_PATH = `/artifacts/${appId}/public/data/fixtures`;
        const VOTES_COLLECTION_PATH = `artifacts/${appId}/public/data/ref_votes`; // NEW
        const VOLUNTEER_COLLECTION_PATH = `artifacts/${appId}/public/data/ref_volunteers`; // NEW
        
        const LOCAL_STORAGE_KEY = `referee-fixtures-${appId}`;

        // Firebase Imports (using CDN links)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, collection, doc, updateDoc, onSnapshot, getDoc, 
            writeBatch, query, getDocs, setDoc, serverTimestamp,
            arrayUnion, arrayRemove, deleteField, where // Added arrayUnion/Remove/deleteField/where
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // Global State
        let app, db, auth;
        let userId = null; // Firebase Auth UID
        let userName = ''; // User's display name/login
        let userRole = 'guest'; // 'guest', 'standard', 'referee', 'admin'
        let isDbReady = false; 

        // NEW: Data arrays
        let fixtures = [];
        let refVotes = { '5s': 0, '7s': 0 }; 
        let refVolunteers = {}; // {shiftKey: [userNames]}
        let refSchedule = []; // Array of assigned shifts/fixtures

        // --- DOM ELEMENTS (NEW) ---
        const appContainer = document.getElementById('app-container');
        const identityToolsBox = document.getElementById('user-control-panel');
        const refToolsArea = document.getElementById('ref-tools-area');
        const voteCountsDisplay = document.getElementById('vote-counts');
        const volunteerShiftsList = document.getElementById('volunteer-shifts-list');
        const loginOrProfileArea = document.getElementById('login-or-profile-area');
        const scheduleModal = document.getElementById('schedule-modal');
        const scheduleList = document.getElementById('schedule-list');
        const adminManageButtonMain = document.getElementById('admin-manage-button-main');
        const adminManageButtonExpanded = document.getElementById('admin-manage-button-expanded');
        const adminModal = document.getElementById('admin-modal');
        const assignModal = document.getElementById('admin-assignment-modal-backdrop');

        // --- Utility Functions ---

        /** Saves fixtures to local storage. Used when Firebase fails. */
        function saveFixturesLocal(fixturesToSave) {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(fixturesToSave));
                console.log(`Fixtures saved to local storage (${fixturesToSave.length} items).`);
            } catch (e) {
                console.error("Failed to save to local storage:", e);
                showStatus('danger', 'Local storage failed. Data will not persist across reloads.');
            }
        }

        /** Loads fixtures from local storage. Used when Firebase fails. */
        function loadFixturesLocal() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error("Failed to load from local storage:", e);
                return [];
            }
        }

        const dateFormatter = new Intl.DateTimeFormat('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });

        /** Shows a status message near the top center */
        function showStatus(type, message) {
            const statusDiv = document.getElementById('status-message');
            if (!statusDiv) return;

            statusDiv.textContent = message;
            
            statusDiv.className = 'fixed top-4 left-1/2 -translate-x-1/2 p-3 rounded-xl shadow-xl z-50 transition-all duration-300 transform';
            statusDiv.classList.remove('hidden');

            statusDiv.classList.remove('bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800', 'border-green-500', 'border-red-500', 'border-yellow-500');
            
            if (type === 'success') {
                statusDiv.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-500');
            } else if (type === 'danger') {
                statusDiv.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-500');
            } else if (type === 'warning') {
                statusDiv.classList.add('bg-yellow-100', 'text-yellow-800', 'border', 'border-yellow-500');
            }
            
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }

        /** Parses the user's plain text input into structured fixture objects. (Unchanged) */
        window.parseFixturesText = function(text) {
            const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            const fixtures = [];
            const dateRegex = /(\d{1,2}\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{4})/i;
            const timeRegex = /\d{1,2}:\d{2}\s*(AM|PM|am|pm)/i;
            const headers = ['venue', 'pitch', 'time', 'vs', 'vs:']; 
            const BYE_KEYWORD = 'bye'; 

            let currentDate = null;
            let fixtureState = 0; 
            let currentFixture = {};

            for (const line of lines) {
                const lowerLine = line.toLowerCase();
                
                const dateMatch = line.match(dateRegex);
                if (dateMatch) {
                    currentDate = dateMatch[0];
                    fixtureState = 0; 
                    currentFixture = {}; 
                    continue;
                }
                
                if (headers.includes(lowerLine)) {
                    continue;
                }

                if (!currentDate) continue; 

                switch (fixtureState) {
                    case 0: 
                        currentFixture = { home: line, date: currentDate };
                        fixtureState = 1;
                        break;
                    case 1: 
                        currentFixture.away = line;
                        fixtureState = 2;
                        break;
                    case 2: 
                        currentFixture.venue = line;
                        fixtureState = 3;
                        break;
                    case 3: 
                        currentFixture.pitch = line;
                        fixtureState = 4;
                        break;
                    case 4: 
                        if (line.match(timeRegex)) {
                            currentFixture.time = line;

                            if (currentFixture.home.toLowerCase().includes(BYE_KEYWORD) || currentFixture.away.toLowerCase().includes(BYE_KEYWORD)) {
                                console.log(`Skipping fixture due to 'bye': ${currentFixture.home} vs ${currentFixture.away}`);
                            } else {
                                const dateObj = new Date(`${currentFixture.date} ${currentFixture.time}`);
                                
                                const tempId = crypto.randomUUID(); 

                                fixtures.push({
                                    ...currentFixture,
                                    id: tempId, 
                                    dateSortable: dateObj.getTime(),
                                    dateFormatted: dateFormatter.format(dateObj),
                                    assignedRef: null,
                                    volunteers: [], 
                                    status: 'open',
                                    type: '11s' // NEW: Mark as 11s
                                });
                            }
                            
                            fixtureState = 0; 
                            currentFixture = {};
                        } 
                        break;
                }
            }
            return fixtures;
        };

        // --- Identity Management (MODIFIED) ---
        
        // Gets user identity from local storage (non-secure)
        function getIdentity() {
            const storedName = localStorage.getItem('userName');
            if (storedName) {
                userName = storedName;
                if (userName === ADMIN_NAME) {
                    currentRole = 'admin';
                } else if (REF_NAMES.includes(userName)) { // Check against predefined Ref list
                    currentRole = 'referee';
                } else {
                    currentRole = 'standard'; // Any other name is a standard user
                }
            } else {
                userName = '';
                currentRole = 'guest';
            }
            return currentRole;
        }

        // Toggles visibility and state based on identity
        function updateUIBasedOnIdentity() {
            const role = getIdentity();
            
            // 1. App Container Visibility (Nothing visible unless logged in)
            appContainer.classList.toggle('hidden', role === 'guest');
            
            // 2. Identity Box State
            const isLogged = role !== 'guest';
            
            // Do not minimize if admin AND the admin modal is open
            const isModalOpen = !adminModal.classList.contains('hidden');
            const shouldMinimize = isLogged && !(role === 'admin' && isModalOpen);
            
            identityToolsBox.classList.toggle('minimized', shouldMinimize);
            
            document.getElementById('minimized-name-display').textContent = isLogged ? `${userName} (${role})` : 'Log In';

            // 3. Identity Box Content (Login Form vs Profile)
            if (isLogged) {
                // User is logged in, show their details and logout
                loginOrProfileArea.innerHTML = `
                    <p class="mb-2 text-sm"><span class="font-semibold text-gray-700">Logged In As:</span> <span id="display-ref-name" class="font-bold text-lg text-red-600">${userName}</span></p>
                    <p class="mb-2 text-sm"><span class="font-semibold text-gray-700">Role:</span> <span id="display-role" class="font-bold ${role === 'admin' ? 'text-red-600' : (role === 'referee' ? 'text-indigo-600' : '')}">${role}</span></p>
                    <button onclick="clearIdentity()" class="text-xs text-gray-500 hover:text-red-500">Logout</button>
                `;
            } else {
                // User is logged out, show the login forms
                loginOrProfileArea.innerHTML = `
                    <div id="identity-form" class="space-y-3">
                        <h3 class="font-bold text-lg text-gray-700">Referee Login</h3>
                        <input type="text" id="referee-name-input" placeholder="Enter Your Full Name (e.g. Ref1)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                        <button onclick="handleRefereeLogin()" class="w-full bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-md">
                            Login as Referee
                        </button>
                        <button onclick="showAdminLoginForm()" class="w-full text-sm text-red-600 hover:text-red-700 p-2">
                            Admin Login
                        </button>
                    </div>
                    <div id="admin-login-form" class="space-y-3 hidden">
                        <h3 class="font-bold text-lg text-red-700">Admin Login</h3>
                        <input type="email" id="admin-email" value="admin@betterfootball.co.nz" placeholder="Email" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                        <input type="password" id="admin-password" value="password" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                        <button onclick="handleAdminLogin()" class="w-full bg-red-600 text-white p-3 rounded-lg font-semibold hover:bg-red-700 transition duration-150 shadow-md">
                            Login as Admin
                        </button>
                        <button onclick="showRefereeLoginForm()" class="w-full text-sm text-gray-600 hover:text-gray-700 p-2">
                            Back to Referee Login
                        </button>
                    </div>
                `;
                showRefereeLoginForm(); // Default to referee login
            }

            // 4. Role-Specific Tools Visibility
            refToolsArea.classList.toggle('hidden', role !== 'referee');
            adminManageButtonMain.classList.toggle('hidden', role !== 'admin');
            adminManageButtonExpanded.classList.toggle('hidden', role !== 'admin' || !isLogged);
            
            // Re-render data
            renderFixtures(fixtures);
            renderRefTools();
        }
        
        window.toggleIdentityBox = (event) => {
             // Stop propagation if the click came from inside the expanded content (e.g. forms, buttons)
            if (event && event.target.closest('#expanded-content')) {
                // But allow clicks on the main box if it's already minimized
                if (identityToolsBox.classList.contains('minimized')) {
                     identityToolsBox.classList.toggle('minimized');
                }
                return;
            }
            // Only toggle if logged in
            if (currentRole !== 'guest') { 
                identityToolsBox.classList.toggle('minimized');
            }
        };
        
        window.showAdminLoginForm = function() {
            document.getElementById('identity-form').classList.add('hidden');
            document.getElementById('admin-login-form').classList.remove('hidden');
        }

        window.showRefereeLoginForm = function() {
            document.getElementById('admin-login-form').classList.add('hidden');
            document.getElementById('identity-form').classList.remove('hidden');
        }

        window.handleRefereeLogin = function() {
            const inputNameElement = document.getElementById('referee-name-input');
            const inputName = inputNameElement ? inputNameElement.value.trim() : '';

            if (!inputName) {
                return showStatus('danger', 'Please enter your full name.');
            }
            
            // Use simple name for login, check against roles
            localStorage.setItem('userName', inputName);
            updateUIBasedOnIdentity();
            
            showStatus('success', `Welcome ${userName}!`);
            setupDataListeners(); // Refresh data listener after login
        };

        window.handleAdminLogin = function() {
            const email = document.getElementById('admin-email')?.value.trim();
            const password = document.getElementById('admin-password')?.value.trim();
            
            if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
                localStorage.setItem('userName', ADMIN_NAME);
                updateUIBasedOnIdentity(); 
                
                if (isDbReady) {
                    showStatus('success', 'Admin login successful. Database ready.');
                } else {
                    showStatus('warning', 'Admin login successful. Database failed. Using local storage fallback.');
                }
                setupDataListeners(); // Refresh data listener after login

            } else {
                showStatus('danger', 'Invalid admin credentials.');
            }
        };

        window.clearIdentity = function() {
            localStorage.removeItem('userName');
            // We don't sign out of Firebase auth, just clear local identity
            updateUIBasedOnIdentity();
            showStatus('warning', 'Logged out.');
            // Re-render fixtures as logged-out user
            renderFixtures(fixtures); 
        };

        // --- Core Firebase Setup ---

        async function initFirebase() {
            const loadingText = document.getElementById('loading-text');

            if (!Object.keys(rawFirebaseConfig).length || !rawFirebaseConfig.projectId) {
                console.warn("Firebase config is invalid or missing. Falling back to local storage.");
                if (loadingText) loadingText.innerHTML = 'âš ï¸ Local Mode: Firebase config missing. Data will not be shared.';
                isDbReady = false;
                updateUIBasedOnIdentity();
                setupDataListeners(); // Attempt local load
                return;
            }
            
            try {
                console.log("Firebase Step 1: Initializing App...");
                app = initializeApp(rawFirebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 3. Authenticate
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // 4. Set up Auth State Listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid; // Firebase Auth ID
                        isDbReady = true;
                        console.log("Firebase Step 4: Authentication complete. User UID:", userId);
                        if (loadingText) loadingText.textContent = 'Authentication successful. Loading data...';
                        setupDataListeners();
                    } else {
                        console.log("Firebase Step 4: User logged out or auth failed.");
                        isDbReady = false;
                        setupDataListeners(); // Trigger local load
                    }
                });
                
                updateUIBasedOnIdentity();

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                isDbReady = false; 
                showStatus('danger', `Setup Error (Falling back to local storage): ${error.message}`);
                updateUIBasedOnIdentity();
                setupDataListeners(); // Attempt local load
            }
        }

        // --- Data Loading and Parsing (Refactored for Local Fallback) ---

        window.parseAndLoadFixtures = async function() {
            if (userRole !== 'admin') {
                return showStatus('danger', 'Permission denied. Only Admin can load fixtures.');
            }

            const pasteText = document.getElementById('fixtures-paste-area')?.value;
            let fixturesToLoad = parseFixturesText(pasteText || '');
            
            if (fixturesToLoad.length === 0) {
                return showStatus('warning', 'Could not parse any fixtures. Check your paste format or ensure all fixtures have two teams (no "bye").');
            }
            
            console.log(`Successfully parsed ${fixturesToLoad.length} fixtures from input.`);
            const pasteArea = document.getElementById('fixtures-paste-area');
            if (pasteArea) pasteArea.value = '';

            toggleAdminModal(); // Close modal on success

            // --- DATABASE ATTEMPT (Primary) ---
            if (isDbReady && db) {
                showStatus('warning', `Parsed ${fixturesToLoad.length} valid fixtures. Attempting persistent database ingestion...`);

                const fixturesCollection = collection(db, FIRES_COLLECTION_PATH);
                const batch = writeBatch(db);
                
                try {
                    // 1. Delete all existing 11s fixtures
                    const q = query(fixturesCollection, where("type", "==", "11s"));
                    const snapshot = await getDocs(q);
                    snapshot.docs.forEach(docSnapshot => {
                        batch.delete(docSnapshot.ref);
                    });

                    // 2. Add new fixtures
                    fixturesToLoad.forEach(fixture => {
                        const fixtureRef = doc(fixturesCollection);
                        
                        const newFixture = {
                            ...fixture,
                            id: fixtureRef.id, 
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp(),
                        };
                        batch.set(fixtureRef, newFixture);
                    });

                    await batch.commit();
                    showStatus('success', `âœ… Successfully loaded and activated ${fixturesToLoad.length} new 11s fixtures. They are now live and shared!`);
                    return; 

                } catch (error) {
                    console.error("Database Write Failed:", error);
                    isDbReady = false; 
                    showStatus('danger', `Data Save Failed: ${error.message}. Falling back to LOCAL STORAGE.`);
                    updateUIBasedOnIdentity(); 
                }
            } 

            // --- LOCAL STORAGE FALLBACK (Secondary) ---
            console.log(`Fallback: Saving ${fixturesToLoad.length} fixtures to local storage.`);
            saveFixturesLocal(fixturesToLoad);
            
            // Re-render the UI with the locally saved data
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) loadingIndicator.classList.add('hidden'); 
            fixtures = fixturesToLoad; // Update global state
            renderFixtures(fixtures);
            showStatus('warning', `âš ï¸ Fixtures loaded LOCALLY. Data is not persistent or shared.`);
        };
        
        window.clearAllFixtures = async () => {
             if (currentRole !== 'admin') return showStatus('danger', 'Only administrators can clear fixtures.');
             if (!confirm("Are you sure you want to delete ALL 11s fixtures? This action cannot be undone.")) return;

             if (isDbReady && db) {
                 try {
                    const q = query(collection(db, FIRES_COLLECTION_PATH), where("type", "==", "11s"));
                    const snapshot = await getDocs(q);
                    const batch = writeBatch(db);
                    snapshot.docs.forEach(d => batch.delete(d.ref));
                    await batch.commit();
                    showStatus('warning', "All 11s fixtures cleared from database.");
                 } catch (error) {
                     console.error("Clear Fixtures Error:", error);
                     showStatus('danger', `Clearing fixtures failed: ${error.message}`);
                 }
             } else {
                 saveFixturesLocal([]);
                 fixtures = [];
                 renderFixtures(fixtures);
                 showStatus('warning', "All 11s fixtures cleared from local storage.");
             }
             toggleAdminModal();
        };

        // --- Data Listener and UI Rendering (Refactored for Local Fallback) ---
        
        function setupDataListeners() {
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) loadingIndicator.classList.remove('hidden');

            // --- LOCAL STORAGE PATH ---
            if (!isDbReady || !db) {
                fixtures = loadFixturesLocal();
                console.log(`Using Local Storage: Loaded ${fixtures.length} fixtures.`);
                if (loadingIndicator) loadingIndicator.classList.add('hidden');
                renderFixtures(fixtures);
                if (fixtures.length === 0 && userName) {
                    const loadingText = document.getElementById('loading-text');
                    if (loadingText) loadingText.innerHTML = 'âš ï¸ Schedule empty. Admin must load fixtures.';
                }
                // Also load local votes/volunteers if they exist
                refVotes = JSON.parse(localStorage.getItem('refVotes')) || { '5s': 0, '7s': 0 };
                refVolunteers = JSON.parse(localStorage.getItem('refVolunteers')) || {};
                updateRefSchedule();
                renderRefTools();
                return; // EXIT local storage path
            }

            // --- FIREBASE PATH ---
            console.log("Firebase Step 5: Setting up live data listener...");
            
            // 1. Fixtures Listener
            const fixturesQuery = query(collection(db, FIRES_COLLECTION_PATH)); 
            onSnapshot(fixturesQuery, (snapshot) => {
                console.log("Listener Update: Received data snapshot (Fixtures).");
                if (loadingIndicator) loadingIndicator.classList.add('hidden'); 
                
                fixtures = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderFixtures(fixtures);
                updateRefSchedule();
            }, (error) => {
                console.error("Firestore listen failed (Fixtures):", error);
                isDbReady = false;
                setupDataListener(); // Fallback to local
                showStatus('danger', 'ðŸ”´ Permissions Error: Cannot read schedule. Using local storage.');
            });
            
            // 2. Ref Votes Listener (NEW)
            onSnapshot(doc(db, VOTES_COLLECTION_PATH, 'night_vote'), (docSnap) => {
                console.log("Listener Update: Received data snapshot (Votes).");
                refVotes = docSnap.exists() ? docSnap.data() : { '5s': 0, '7s': 0 };
                renderRefTools();
            }, (error) => { console.error("Error fetching votes:", error); });
            
            // 3. Ref Volunteers Listener (NEW)
            onSnapshot(collection(db, VOLUNTEER_COLLECTION_PATH), (snapshot) => {
                console.log("Listener Update: Received data snapshot (Volunteers).");
                const volunteersData = {};
                snapshot.forEach(doc => {
                    volunteersData[doc.id] = doc.data().volunteers || [];
                });
                refVolunteers = volunteersData;
                renderRefTools();
                updateRefSchedule(); // Update schedule if volunteer list changes
            }, (error) => { console.error("Error fetching volunteers:", error); });
        }
        
        // This function recalculates the ref's schedule from the main data arrays
        function updateRefSchedule() {
             // Get assigned 11s fixtures
             const assignedFixtures = fixtures.filter(f => f.assignedRef === userName);

             // Get assigned/volunteered shifts
             const shiftsConfig = [
                { key: 'mon_bw', label: "Mon: Boyd Wilson (5:50pm - 10:10pm)", match: "5s/7s Shift" },
                { key: 'wed_bw', label: "Wed: Boyd Wilson (5:50pm - 10:10pm)", match: "5s/7s Shift" },
                { key: 'wed_am', label: "Wed: Alex Moore (7:20pm - 9:40pm)", match: "5s/7s Shift" },
                { key: 'tue_hub', label: "Tue: 5's at The Hub (7:00pm - 10:00pm)", match: "5s Night Shift" },
                { key: 'thu_tw', label: "Thu: 5's Te Whaea (7:20pm - 9:40pm)", match: "5s Night Shift" },
             ];
             
             const assignedShifts = shiftsConfig.filter(shift => {
                 const volunteers = refVolunteers[shift.key] || [];
                 return volunteers.includes(userName);
             }).map(shift => ({
                 id: shift.key,
                 dateSortable: 0, // Shifts don't have a date, sort to top/bottom
                 dateFormatted: "Weekly Shift",
                 time: shift.label.split('(')[1].replace(')', '').trim(),
                 location: shift.label.split('(')[0].trim(),
                 home: shift.match,
                 away: userName,
                 type: 'shift'
             }));
             
             refSchedule = [...assignedFixtures, ...assignedShifts];
             
             // Re-render only if the modal is open
             if (!scheduleModal.classList.contains('hidden')) {
                 renderRefScheduleModal();
             }
        }

        function renderFixtures(allFixtures) {
            const upcomingList = document.getElementById('upcoming-fixtures-list');
            if (!upcomingList) return; 
            
            upcomingList.innerHTML = '';
            
            const now = new Date().getTime();
            let currentGroupedDate = null;
            let fixtureCount = 0;

            // Sort all fixtures by date first
            allFixtures.sort((a, b) => a.dateSortable - b.dateSortable);

            allFixtures.forEach(fixture => {
                if (!fixture.home || !fixture.away || !fixture.dateSortable || !fixture.dateFormatted) {
                     return; 
                }
                
                // Skip non-11s types from this list
                if (fixture.type !== '11s') return;

                if (fixture.dateSortable < now) return; // Skip past fixtures
                fixtureCount++;
                
                const dateHeaderKey = fixture.dateFormatted;
                
                if (dateHeaderKey !== currentGroupedDate) {
                    currentGroupedDate = dateHeaderKey;
                    const dateHeader = document.createElement('h3');
                    dateHeader.className = "text-xl font-bold text-gray-800 mt-6 mb-3 p-2 bg-gray-200 rounded-lg shadow-inner";
                    dateHeader.textContent = currentGroupedDate;
                    upcomingList.appendChild(dateHeader);
                }

                const card = document.createElement('div');
                const volunteerCount = fixture.volunteers ? fixture.volunteers.length : 0;
                const isVolunteer = userName && fixture.volunteers && fixture.volunteers.includes(userName);
                
                let baseClasses = "fixture-card p-4 rounded-xl transition duration-300 shadow-md";
                let actionHtml = '';

                // --- Card Styling and Status ---
                if (fixture.status === 'assigned') {
                    baseClasses += ' bg-green-50 border-l-4 border-green-500';
                } else if (isVolunteer) {
                     baseClasses += ' bg-yellow-50 border-l-4 border-yellow-500 hover:shadow-lg';
                } else {
                    baseClasses += ' bg-white border-l-4 border-red-500 hover:shadow-xl';
                }
                
                // Add admin clickability
                if (userRole === 'admin') {
                    card.classList.add('admin-clickable');
                    // Safely stringify volunteers array
                    const volunteersJson = JSON.stringify(fixture.volunteers || []);
                    card.setAttribute('onclick', `openAssignmentModal('${fixture.id}', '${fixture.home.replace(/'/g, "\\'")}', '${fixture.away.replace(/'/g, "\\'")}', '${dateHeaderKey.replace(/'/g, "\\'")}', '${fixture.time.replace(/'/g, "\\'")}', '${volunteersJson.replace(/'/g, "\\'")}', '${fixture.assignedRef ? fixture.assignedRef.replace(/'/g, "\\'") : ''}')`);
                }

                card.className = baseClasses;
                
                // --- Action Content (Admin vs Referee) ---
                if (userRole === 'admin') {
                    if (fixture.status === 'open') {
                         actionHtml = `
                            <div class="p-2 text-center text-sm">
                                <span class="font-bold text-red-600">${volunteerCount} <span class="hidden sm:inline">Volunteer(s)</span></span>
                                <p class="text-xs text-gray-500 mt-1">Click to Assign/Edit</p>
                            </div>`;
                    } else { 
                        actionHtml = `
                            <div class="p-2 text-center text-xs space-y-1">
                                <p class="font-bold text-green-600 truncate">${fixture.assignedRef}</p>
                                <p class="text-xs text-gray-500 mt-1">Click to Unassign/Edit</p>
                            </div>`;
                    }
                } 
                else if (userName && (userRole === 'referee' || REF_NAMES.includes(userName)) ) { // Check against role AND name list
                    if (fixture.status === 'assigned') {
                        actionHtml = `<div class="p-2 text-center text-sm text-green-600 font-bold">Assigned to: ${fixture.assignedRef}</div>`;
                    } else {
                        const actionClass = isVolunteer ? 'bg-red-500 hover:bg-red-600' : 'bg-indigo-600 hover:bg-indigo-700';
                        const actionText = isVolunteer ? 'Cancel Application' : 'Apply Now';
                        const actionState = isVolunteer ? 'false' : 'true'; 

                        actionHtml = `
                            <button onclick="handleVolunteer(event, '${fixture.id}', ${actionState})" class="w-full h-full text-white p-2 font-semibold text-sm ${actionClass} transition duration-150">
                                ${actionText}
                            </button>`;
                    }
                } else {
                    actionHtml = `<div class="p-2 text-center text-sm text-gray-500">${fixture.status === 'assigned' ? 'Assigned' : 'Login to Apply'}</div>`;
                }
                
                // Card content from user's file (restored)
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3 border-b pb-2">
                        <div>
                            <span class="text-xl font-extrabold ${'text-gray-900'} block">${fixture.date}</span>
                            <span class="text-sm font-semibold ${'text-red-600'}">${fixture.time}</span>
                        </div>
                         <div class="text-right text-sm">
                            <p class="font-semibold">${fixture.venue}</p>
                            <span class="inline-block bg-gray-200 rounded-full px-2 py-0.5 mt-1 text-xs font-medium">Pitch ${fixture.pitch}</span>
                        </div>
                    </div>
                    <div class="flex flex-col mb-4">
                        <p class="text-2xl font-bold ${'text-gray-800'}">${fixture.home}</p>
                        <p class="text-base font-semibold ${'text-gray-800'}">vs</p>
                        <p class="text-2xl font-bold ${'text-gray-800'}">${fixture.away}</p>
                    </div>
                    <div class="pt-3 border-t">
                        ${actionHtml}
                    </div>
                `;
                upcomingList.appendChild(card);
            });
            
            if (fixtureCount === 0) {
                upcomingList.innerHTML = `<p class="text-center py-10 text-gray-500">No upcoming 11s fixtures found. Admin needs to load the schedule.</p>`;
            }
        }
        
        // --- NEW: Render Ref Tools Section ---
        function renderRefTools() {
            if (currentRole !== 'referee') return;
            
            // 1. Render Vote Counts
            const totalVotes = (refVotes['5s'] || 0) + (refVotes['7s'] || 0);
            voteCountsDisplay.innerHTML = `
                <span class="text-gray-600">Total Votes: ${totalVotes}</span> | 
                <span class="font-bold text-indigo-600">${refVotes['5s'] || 0}</span> for 5s / 
                <span class="font-bold text-indigo-600">${refVotes['7s'] || 0}</span> for 7s
            `;

            // 2. Render Volunteering Shifts
            const shiftsConfig = [
                { key: 'mon_bw', label: "Mon: Boyd Wilson (5:50pm - 10:10pm)" },
                { key: 'wed_bw', label: "Wed: Boyd Wilson (5:50pm - 10:10pm)" },
                { key: 'wed_am', label: "Wed: Alex Moore (7:20pm - 9:40pm)" },
                { key: 'tue_hub', label: "Tue: 5's at The Hub (7:00pm - 10:00pm)" },
                { key: 'thu_tw', label: "Thu: 5's Te Whaea (7:20pm - 9:40pm)" },
            ];
            
            const shiftsHtml = shiftsConfig.map(shift => {
                const volunteers = refVolunteers[shift.key] || [];
                const volunteered = volunteers.includes(userName);
                return `
                    <button 
                            data-shift-key="${shift.key}" 
                            class="ref-shift-btn action-button text-xs py-2 px-3 rounded-full border ${volunteered ? 'volunteered' : 'bg-white hover:bg-gray-100 text-gray-700 border-gray-300'}"
                            onclick="window.toggleVolunteer('${shift.key}')">
                        ${shift.label} (${volunteers.length} signed up)
                    </button>
                `;
            }).join('');
            
            volunteerShiftsList.innerHTML = shiftsHtml;
        }
        
        // --- NEW: Render Ref Schedule Modal ---
        function renderRefScheduleModal() {
            scheduleList.innerHTML = '';
            
            if (refSchedule.length === 0) {
                scheduleList.innerHTML = '<p class="text-gray-500 italic">You have no approved assignments yet.</p>';
                return;
            }

            refSchedule.sort((a, b) => a.dateSortable - b.dateSortable || (a.time || '').localeCompare(b.time || ''));

            refSchedule.forEach(game => {
                const isShift = game.type === 'shift';
                const item = document.createElement('div');
                item.className = 'p-3 border-b border-gray-200';
                item.innerHTML = `
                    <div class="font-bold text-gray-800">
                        ${isShift ? game.location : `${game.time} - ${game.location} (P${game.pitch})`}
                    </div>
                    <div class="text-sm text-gray-600 mt-1">
                        ${isShift ? `Shift: ${game.time}` : `Match: ${game.home} vs ${game.away}`}
                    </div>
                    <div class="text-sm ${isShift ? 'text-green-600' : 'text-indigo-600'} mt-1 font-semibold">
                        Status: ${isShift ? 'Volunteered / Approved' : 'Assigned by Admin'}
                    </div>
                `;
                scheduleList.appendChild(item);
            });
        }
        
        // --- NEW: Ref Action Handlers ---
        window.handleVote = async (type) => {
            if (currentRole !== 'referee') return showStatus('danger', 'Only referees can vote.');

            if (!isDbReady || !db) {
                 // Local storage fallback
                 refVotes[type] = (refVotes[type] || 0) + 1;
                 localStorage.setItem('refVotes', JSON.stringify(refVotes));
                 renderRefTools();
                 showStatus('success', `Voted for ${type} (locally)!`);
                 return;
            }

            const voteRef = doc(db, VOTES_COLLECTION_PATH, 'night_vote');
            try {
                // Use { merge: true } to avoid overwriting the other vote type
                await setDoc(voteRef, { [type]: (refVotes[type] || 0) + 1 }, { merge: true });
                showStatus('success', `Voted for ${type} successfully!`);
            } catch (error) {
                console.error("Vote Error:", error);
                showStatus('danger', "Voting failed. Try again.");
            }
        };
        
        window.toggleVolunteer = async (shiftKey) => {
            if (currentRole !== 'referee') return showStatus('danger', 'Only referees can volunteer.');

            const currentVolunteersList = refVolunteers[shiftKey] || [];
            const volunteered = currentVolunteersList.includes(userName);
            let updatedVolunteers;

            if (volunteered) {
                updatedVolunteers = currentVolunteersList.filter(name => name !== userName);
            } else {
                updatedVolunteers = [...currentVolunteersList, userName];
            }

            if (!isDbReady || !db) {
                // Local storage fallback
                refVolunteers[shiftKey] = updatedVolunteers;
                localStorage.setItem('refVolunteers', JSON.stringify(refVolunteers));
                renderRefTools();
                updateRefSchedule();
                showStatus('success', volunteered ? 'Withdrew volunteer (locally).' : 'Volunteered for shift (locally).');
                return;
            }

            const shiftRef = doc(db, VOLUNTEER_COLLECTION_PATH, shiftKey);
            try {
                 // Use setDoc instead of updateDoc with arrayUnion/Remove for simplicity
                 await setDoc(shiftRef, { volunteers: updatedVolunteers });
                 showStatus('success', volunteered ? 'Withdrew volunteer offer.' : 'Volunteered for shift!');
            } catch (error) {
                console.error("Volunteering Error:", error);
                showStatus('danger', "Volunteering update failed. Try again.");
            }
        };
        
        window.showRefSchedule = () => {
            if (currentRole !== 'referee') return showStatus('danger', 'Only referees have a schedule.');
            renderRefScheduleModal();
            scheduleModal.style.display = 'flex';
            setTimeout(() => scheduleModal.classList.add('show'), 10);
        }
        
        window.closeScheduleModal = () => {
            scheduleModal.classList.remove('show');
            setTimeout(() => scheduleModal.style.display = 'none', 200);
        }

        // --- NEW: Admin Modal Handlers ---
        window.toggleAdminModal = () => {
            if (currentRole !== 'admin') return showStatus('danger', 'Only administrators can manage fixtures.');
            const isHidden = adminModal.style.display === 'none' || !adminModal.classList.contains('show');
            
            if (isHidden) {
                adminModal.style.display = 'flex';
                setTimeout(() => adminModal.classList.add('show'), 10);
            } else {
                adminModal.classList.remove('show');
                setTimeout(() => adminModal.style.display = 'none', 200);
            }
            updateUIBasedOnIdentity();
        };

        // --- Admin Assignment Modal Logic (Unchanged) ---

        window.openAssignmentModal = function(matchId, home, away, date, time, volunteersJson, assignedRef) {
            if (userRole !== 'admin') return;

            let volunteers;
            try {
                volunteers = JSON.parse(volunteersJson.replace(/\\'/g, "'"));
            } catch (e) {
                volunteers = [];
            }
            
            const modalBackdrop = document.getElementById('admin-assignment-modal-backdrop');
            const titleElement = document.getElementById('modal-match-title');
            const detailsElement = document.getElementById('modal-match-details');
            const listContainer = document.getElementById('volunteer-list-container');
            const matchIdInput = document.getElementById('modal-match-id');
            const assignButton = document.getElementById('assign-button');
            
            // NEW: Populate Quick Edit Form
            document.getElementById('edit-match-id').value = matchId;
            const match = fixtures.find(f => f.id === matchId);
            if(match) {
                 document.getElementById('edit-time').value = match.time || '';
                 document.getElementById('edit-location').value = match.venue || '';
                 document.getElementById('edit-pitch').value = match.pitch || '';
            }

            if (!modalBackdot or !titleElement || !detailsElement || !listContainer || !matchIdInput || !assignButton) {
                return;
            }

            titleElement.textContent = `${home} vs ${away}`;
            detailsElement.textContent = `${date} at ${time}`;
            matchIdInput.value = matchId;
            listContainer.innerHTML = ''; 

            if (assignedRef && assignedRef !== 'null' && assignedRef !== 'undefined') {
                 listContainer.innerHTML = `<p class="font-bold text-green-600">Currently Assigned: ${assignedRef}</p>`;
                 assignButton.disabled = true;
                 assignButton.textContent = 'Already Assigned';
            } else if (volunteers.length === 0) {
                listContainer.innerHTML = '<p class="text-sm text-gray-600">No referees have volunteered for this match yet.</p>';
                assignButton.disabled = true;
                assignButton.textContent = 'No Volunteers';
            } else {
                volunteers.forEach(name => {
                    const safeName = name.replace(/[^a-z0-9]/gi, '_'); 
                    const radioId = `ref-${safeName}`; 
                    listContainer.innerHTML += `
                        <label for="${radioId}" class="flex items-center p-2 bg-white rounded-lg cursor-pointer hover:bg-red-50 transition">
                            <input type="radio" id="${radioId}" name="selected_ref" value="${name}" class="text-red-600 focus:ring-red-500 h-4 w-4">
                            <span class="ml-3 font-medium text-gray-900">${name}</span>
                        </label>
                    `;
                });
                assignButton.disabled = true; 
                assignButton.textContent = 'Confirm Assignment';
                
                document.querySelectorAll('input[name="selected_ref"]').forEach(radio => {
                    radio.addEventListener('change', () => {
                        assignButton.disabled = false;
                    });
                });
            }

            modalBackdrop.classList.add('show');
            modalBackdrop.style.display = 'flex';
        }

        window.closeAssignmentModal = function() {
            const modalBackdrop = document.getElementById('admin-assignment-modal-backdrop');
            if (!modalBackdrop) return;

            modalBackdrop.classList.remove('show');
            setTimeout(() => {
                modalBackdrop.style.display = 'none';
            }, 200); 
        }

        window.handleFinalAssignment = async function() {
            if (userRole !== 'admin') return showStatus('danger', 'Only administrators can make assignments.');

            const matchId = document.getElementById('modal-match-id')?.value;
            const selectedRefElement = document.querySelector('input[name="selected_ref"]:checked');
            
            if (!selectedRefElement || !matchId) {
                return showStatus('warning', 'Missing required information.');
            }
            const targetRefName = selectedRefElement.value;

            if (isDbReady && db) {
                const matchRef = doc(db, FIRES_COLLECTION_PATH, matchId);
                try {
                    await updateDoc(matchRef, {
                        assignedRef: targetRefName,
                        status: 'assigned',
                        updatedAt: serverTimestamp()
                    });
                    closeAssignmentModal();
                    return showStatus('success', `âœ… ${targetRefName} ASSIGNED to match! Schedule updated.`);
                } catch(e) {
                    isDbReady = false;
                    showStatus('danger', 'Database write failed. Falling back to local storage update.');
                    updateUIBasedOnIdentity();
                }
            }

            updateLocalFixture(matchId, {
                assignedRef: targetRefName,
                status: 'assigned',
                updatedAt: new Date().getTime() 
            });
            closeAssignmentModal();
            showStatus('success', `âœ… ${targetRefName} ASSIGNED locally.`);
        };
        
        // NEW: Handle Quick Edit
        window.handleQuickEdit = async () => {
             if (currentRole !== 'admin') return showStatus('danger', 'Only administrators can edit.');
             
             const matchId = document.getElementById('edit-match-id').value;
             const newTime = document.getElementById('edit-time').value;
             const newLocation = document.getElementById('edit-location').value;
             const newPitch = document.getElementById('edit-pitch').value;
             
             const updates = {
                 time: newTime,
                 venue: newLocation,
                 pitch: newPitch,
                 updatedAt: isDbReady ? serverTimestamp() : new Date().getTime()
             };

             if (isDbReady && db) {
                 const matchRef = doc(db, FIRES_COLLECTION_PATH, matchId);
                 try {
                     await updateDoc(matchRef, updates);
                     showStatus('success', 'Fixture details updated!');
                     closeAssignmentModal();
                 } catch (error) {
                     console.error("Quick Edit Error:", error);
                     showStatus('danger', 'Failed to update fixture.');
                 }
             } else {
                 updateLocalFixture(matchId, updates);
                 showStatus('success', 'Fixture details updated (locally).');
                 closeAssignmentModal();
             }
        };

        // --- Referee Action: Volunteer/Cancel (Refactored for Local Fallback) ---
        window.handleVolunteer = async function(event, matchId, isVolunteering) {
            event.stopPropagation(); 
            
            if (!userName || userRole === 'guest') return showStatus('danger', 'Please log in first.');
            if (userRole === 'admin') return showStatus('danger', 'Admin cannot volunteer.');

            if (isDbReady && db) {
                const matchRef = doc(db, FIRES_COLLECTION_PATH, matchId);
                try {
                    const updateAction = isVolunteering ? arrayUnion(userName) : arrayRemove(userName);
                    await updateDoc(matchRef, { 
                        volunteers: updateAction,
                        updatedAt: serverTimestamp()
                    });
                    return showStatus('success', isVolunteering ? `âœ… ${userName}, you have applied for this match!` : 'âŒ Application cancelled.');
                } catch(e) {
                    isDbReady = false;
                    showStatus('danger', 'Database write failed. Falling back to local storage update.');
                    updateUIBasedOnIdentity();
                }
            }
            
            const fixture = fixtures.find(f => f.id === matchId);
            
            if (fixture) {
                const currentVolunteers = fixture.volunteers || [];
                let updatedVolunteers;
                if (isVolunteering) {
                    if (!currentVolunteers.includes(userName)) {
                        updatedVolunteers = [...currentVolunteers, userName];
                        showStatus('success', `âœ… ${userName}, you have applied for this match locally.`);
                    }
                } else {
                    updatedVolunteers = currentVolunteers.filter(name => name !== userName);
                    showStatus('warning', 'âŒ Application cancelled locally.');
                }
                updateLocalFixture(matchId, { volunteers: updatedVolunteers });
            }
        };

        /** Admin clears a final assignment. (Refactored for Local Fallback) */
        window.handleUnassign = async function(matchId) {
             if (userRole !== 'admin') return showStatus('danger', 'Only administrators can unassign.');
            
             if (isDbReady && db) {
                 const matchRef = doc(db, FIRES_COLLECTION_PATH, matchId);
                 try {
                     await updateDoc(matchRef, {
                        assignedRef: deleteField(),
                        status: 'open',
                        updatedAt: serverTimestamp()
                     });
                     return showStatus('warning', 'Assignment cleared. Match is now open for volunteering.');
                 } catch(e) {
                     isDbReady = false;
                     showStatus('danger', 'Database write failed. Falling back to local storage update.');
                     updateUIBasedOnIdentity();
                 }
             }

             updateLocalFixture(matchId, {
                assignedRef: null,
                status: 'open',
                updatedAt: new Date().getTime()
             });
             showStatus('warning', 'Assignment cleared locally.');
        }

        /** Helper to find and update a local fixture object */
        function updateLocalFixture(matchId, updates) {
            const index = fixtures.findIndex(f => f.id === matchId);
            
            if (index !== -1) {
                fixtures[index] = { ...fixtures[index], ...updates };
                saveFixturesLocal(fixtures);
                // Immediately update the UI to reflect the change
                renderFixtures(fixtures.sort((a, b) => a.dateSortable - b.dateSortable));
            }
        }

        /** Master function to start the app logic. */
        function startApp() {
            updateUIBasedOnIdentity();
            initFirebase();
        }

        startApp();
    </script>
</body>
</html>
