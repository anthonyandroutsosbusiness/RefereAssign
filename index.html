<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weekly Referee Assignment System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }

    .fixture-card {
      transition: all 0.22s cubic-bezier(.2,.9,.2,1);
      box-shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.04);
      display:flex; flex-direction:column; cursor: default;
    }
    .fixture-main-content { display:flex; align-items:center; flex-grow:1; gap:1.5rem; padding:0.75rem 1rem; }
    .fixture-action-area { padding:0.5rem 1rem; border-top:1px solid #f3f4f6; background:#fff; }
    .admin-section { background:#ffe0e0; border:2px solid #ef4444; }
    .modal-backdrop { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:50; display:none; justify-content:center; align-items:center; }
    .modal-content { max-width:90vw; width:500px; max-height:90vh; overflow-y:auto; transform:scale(0.95); transition:all 0.2s ease; }
    .modal-backdrop.show .modal-content { transform:scale(1); }
    @media (min-width:640px) {
      .fixture-card { flex-direction:row; height:80px; padding:0; }
      .fixture-main-content { padding:0 1rem; }
      .fixture-action-area { width:150px; border-top:none; border-left:1px solid #f3f4f6; padding:0; height:100%; display:flex; align-items:center; justify-content:center; }
    }
    .nightshift-card { min-width:140px; max-width:240px; transition:all .25s; }
    .faded { opacity:0.35; filter:grayscale(0.35); transform:scale(.995); }
    .panel-collapsed { width:3.5rem !important; opacity:0.85; }
    /* small responsive tweak for identity panel content when collapsed */
    .collapsed-hide { display:none !important; }
  </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

  <div id="status-message" class="fixed top-4 left-1/2 -translate-x-1/2 p-3 rounded-xl shadow-xl z-50 hidden transition-all duration-300 transform" style="max-width:90vw;"></div>

  <!-- MY IDENTITY & TOOLS PANEL (slightly smaller + collapsible) -->
  <div id="user-control-panel" class="w-full max-w-sm mx-auto bg-white p-3 rounded-xl shadow-2xl border-t-4 border-red-600 mb-6 sm:mb-0 sm:float-right sm:sticky sm:top-8 transition-all" style="backdrop-filter: blur(1px);">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-bold text-gray-800">My Identity & Tools</h2>
      <div class="flex items-center gap-2">
        <button id="collapse-panel-btn" onclick="toggleControlPanel()" class="text-sm text-gray-600 hover:text-gray-800">‚ñ≤</button>
      </div>
    </div>

    <div id="panel-content" class="mt-2">
      <div id="identity-form" class="space-y-2">
        <h3 class="font-bold text-md text-gray-700">Referee Login</h3>
        <input type="text" id="referee-name-input" placeholder="Enter Your Full Name" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 text-sm">
        <div class="flex gap-2">
          <button onclick="handleRefereeLogin()" class="flex-1 bg-indigo-600 text-white p-2 rounded-lg font-semibold hover:bg-indigo-700 text-sm">Login as Referee</button>
          <button onclick="showAdminLoginForm()" class="text-sm text-red-600 hover:text-red-700 p-2">Admin</button>
        </div>
      </div>

      <div id="admin-login-form" class="space-y-2 hidden">
        <h3 class="font-bold text-md text-red-700">Admin Login</h3>
        <input type="email" id="admin-email" value="admin@betterfootball.co.nz" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
        <input type="password" id="admin-password" value="password" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
        <div class="flex gap-2">
          <button onclick="handleAdminLogin()" class="flex-1 bg-red-600 text-white p-2 rounded-lg font-semibold hover:bg-red-700 text-sm">Login</button>
          <button onclick="showRefereeLoginForm()" class="text-sm text-gray-600 p-2">Back</button>
        </div>
      </div>

      <div id="identity-display" class="hidden mt-2">
        <p class="mb-1 text-sm"><span class="font-semibold text-gray-700">Logged In As:</span> <span id="display-ref-name" class="font-bold text-lg text-red-600"></span></p>
        <p class="mb-2 text-sm"><span class="font-semibold text-gray-700">Role:</span> <span id="display-role" class="font-bold"></span></p>
        <div class="flex gap-2">
          <button onclick="clearIdentity()" class="text-xs text-gray-500 hover:text-red-500">Logout</button>
        </div>
      </div>

      <div id="admin-panel" class="mt-3 p-3 rounded-xl admin-section hidden transition-all duration-200">
        <div id="admin-panel-summary" class="flex justify-between items-center cursor-pointer">
          <h3 class="font-bold text-red-700 text-sm">Load Fixtures (Admin Tool)</h3>
          <span id="admin-toggle-icon" class="text-red-700 text-lg font-bold">+</span>
        </div>
        <div id="admin-panel-details" class="mt-2 pt-2 border-t border-red-400 hidden">
          <p class="text-xs text-gray-700 mb-2">Paste the <strong>EXACT</strong> vertical schedule below. Fixtures with 'bye' will be skipped.</p>
          <textarea id="fixtures-paste-area" rows="4" placeholder="Paste fixture data here..." class="w-full p-2 border border-red-300 rounded-lg text-xs"></textarea>
          <button onclick="parseAndLoadFixtures()" class="w-full mt-2 bg-red-600 text-white p-2 rounded-lg font-semibold hover:bg-red-700 text-sm">Process and Load Fixtures</button>
          <p id="db-status-message" class="text-xs font-semibold text-red-700 mt-2 hidden">Attempting to connect to database...</p>
        </div>
      </div>
    </div>
  </div>
  <!-- END IDENTITY PANEL -->

  <main class="w-full max-w-4xl mx-auto sm:mr-96">
    <header class="text-center mb-5">
      <h1 class="text-4xl font-extrabold text-gray-900 mb-1">Weekly Match Assignments</h1>
      <p id="ref-greeting" class="text-lg text-gray-600">Please log in to view the schedule.</p>
    </header>

    <!-- APPROVED ASSIGNMENTS (for referees) -->
    <div id="approved-fixtures-container" class="hidden mb-4">
      <h2 class="text-2xl font-bold text-green-700 border-b pb-2 mb-3">Your Approved Assignments</h2>
      <div id="approved-fixtures-list" class="space-y-3 mb-4"></div>
    </div>

    <h2 class="text-2xl font-bold text-gray-700 border-b pb-2 mb-4">Upcoming Schedule</h2>

    <!-- NIGHT SHIFT SECTION START -->
    <!-- Static night shifts shown ONLY at the top as cards to apply for -->
    <div id="night-shifts-wrapper" class="mb-6">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-2xl font-bold text-gray-700">5s &amp; 7s Night Shifts</h3>
        <div id="night-shift-admin-controls" class="hidden">
          <button id="restore-hidden-btn" onclick="restoreHiddenNightShifts()" class="text-sm text-indigo-600 hover:text-indigo-800 hidden">üîÅ Restore Hidden Night Shifts</button>
        </div>
      </div>

      <div id="night-shifts-container" class="flex flex-wrap gap-3">
        <!-- rendered by JS -->
      </div>
    </div>
    <!-- NIGHT SHIFT SECTION END -->

    <!-- ADD FIXTURE SECTION START -->
    <div id="add-fixture-section" class="mb-4 hidden">
      <div class="flex items-center gap-3 mb-2">
        <button id="open-add-fixture-btn" onclick="toggleAddFixtureForm(true)" class="px-3 py-1 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 text-sm">‚ûï Add Fixture</button>
        <span class="text-sm text-gray-500">Quick add a single 11s fixture (saves immediately).</span>
      </div>

      <div id="add-fixture-form" class="bg-white p-3 rounded-xl shadow-sm hidden">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
          <input id="new-fixture-date" type="date" class="p-2 border rounded text-sm" />
          <input id="new-fixture-time" type="time" class="p-2 border rounded text-sm" />
          <input id="new-fixture-venue" placeholder="Venue" class="p-2 border rounded text-sm" />
          <input id="new-fixture-home" placeholder="Home Team" class="p-2 border rounded text-sm" />
          <input id="new-fixture-away" placeholder="Away Team" class="p-2 border rounded text-sm" />
          <input id="new-fixture-pitch" placeholder="Pitch" class="p-2 border rounded text-sm" />
        </div>
        <div class="mt-3 flex gap-2">
          <button onclick="handleAddFixture()" class="px-3 py-1 bg-green-600 text-white rounded font-semibold hover:bg-green-700 text-sm">Save Fixture</button>
          <button onclick="toggleAddFixtureForm(false)" class="px-3 py-1 border rounded text-sm">Cancel</button>
        </div>
      </div>
    </div>
    <!-- ADD FIXTURE SECTION END -->

    <div id="upcoming-fixtures-list" class="space-y-3">
      <div id="loading-indicator" class="text-center text-gray-500 py-10">
        <svg class="animate-spin h-8 w-8 text-gray-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-3" id="loading-text">Connecting to database...</p>
      </div>
    </div>
  </main>

  <!-- ADMIN ASSIGNMENT MODAL (unchanged visual) -->
  <div id="admin-assignment-modal-backdrop" class="modal-backdrop transition-opacity duration-300">
    <div id="admin-assignment-modal-content" class="modal-content bg-white p-6 rounded-xl shadow-2xl">
      <h3 class="text-2xl font-bold text-red-600 border-b pb-2 mb-4" id="modal-match-title"></h3>
      <p class="text-sm text-gray-600 mb-4" id="modal-match-details"></p>

      <form id="assignment-form" onsubmit="return false;" class="space-y-3">
        <p class="font-semibold text-gray-700">Select Referee to Assign:</p>
        <div id="volunteer-list-container" class="bg-gray-100 p-3 rounded-lg max-h-48 overflow-y-auto space-y-2 border"></div>
        <input type="hidden" id="modal-match-id">
        <div class="flex justify-end pt-4 space-x-3">
          <button type="button" onclick="closeAssignmentModal()" class="px-4 py-2 text-gray-700 border rounded-lg hover:bg-gray-100 transition">Cancel</button>
          <button type="submit" onclick="handleFinalAssignment()" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition" disabled id="assign-button">Confirm Assignment</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
  // -----------------------------
  // GLOBAL CONFIG AND CONSTANTS
  // -----------------------------
  let rawFirebaseConfig = {};
  try { rawFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {}; } catch(e){ rawFirebaseConfig = {}; console.error('Bad firebase config', e); }

  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
  const ADMIN_EMAIL = 'admin@betterfootball.co.nz';
  const ADMIN_PASSWORD = 'password';
  const ADMIN_NAME = 'BetterFootball Admin';
  const FIRES_COLLECTION_PATH = `/artifacts/${appId}/public/data/fixtures`;
  const LOCAL_STORAGE_KEY = `referee-fixtures-${appId}`;

  // Static night shifts
  const NIGHT_SHIFTS = [
    { id:'night-boyd-mon', venue:'Boyd Wilson', pitch:'5s', format:'5s', isNightShift:true },
    { id:'night-hub-5s', venue:'The Hub', pitch:'5s', format:'5s', isNightShift:true },
    { id:'night-boyd-wed7', venue:'Boyd Wilson', pitch:'7s', format:'7s', isNightShift:true },
    { id:'night-alex-wed7', venue:'Alex Moore', pitch:'7s', format:'7s', isNightShift:true },
    { id:'night-teawhaea-thurs5', venue:'Te Whaea', pitch:'5s', format:'5s', isNightShift:true }
  ];

  // Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, collection, doc, updateDoc, onSnapshot, writeBatch, query, getDocs, serverTimestamp, arrayUnion, arrayRemove, setLogLevel, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  setLogLevel('Debug');

  let app, db, auth;
  let userId = null, userName = '', userRole = 'none', isDbReady = false;
  const editingIds = new Set();

  // -----------------------------
  // UTILITIES: local storage save/load
  // -----------------------------
  function saveFixturesLocal(fixtures) {
    try {
      // Persist only fixtures that have state or are weekly fixtures or night shifts with state.
      const toSave = fixtures.filter(f => f.isNightShift || f.assignedRef || (f.volunteers && f.volunteers.length>0) || !f.isNightShift || f.hiddenThisWeek);
      localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(toSave));
    } catch(e){ console.error('save local failed', e); showStatus('danger', 'Local save failed'); }
  }

  function loadFixturesLocal() {
    try {
      const raw = localStorage.getItem(LOCAL_STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch(e){ console.error('load local failed', e); return []; }
  }

  const dateFormatter = new Intl.DateTimeFormat('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

  function showStatus(type, msg) {
    const div = document.getElementById('status-message');
    if(!div) return;
    div.textContent = msg;
    div.className = 'fixed top-4 left-1/2 -translate-x-1/2 p-3 rounded-xl shadow-xl z-50 transition-all duration-300 transform';
    div.classList.remove('hidden');
    div.classList.remove('bg-green-100','text-green-800','bg-red-100','text-red-800','bg-yellow-100','text-yellow-800');
    if(type === 'success'){ div.classList.add('bg-green-100','text-green-800','border','border-green-500'); }
    else if(type === 'danger'){ div.classList.add('bg-red-100','text-red-800','border','border-red-500'); }
    else if(type === 'warning'){ div.classList.add('bg-yellow-100','text-yellow-800','border','border-yellow-500'); }
    setTimeout(()=>div.classList.add('hidden'),4500);
  }

  // -----------------------------
  // PARSER (unchanged)
  // -----------------------------
  window.parseFixturesText = function(text) {
    const lines = text.split('\n').map(l=>l.trim()).filter(Boolean);
    const fixtures = [];
    const dateRegex = /(\d{1,2}\s+(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s+\d{4})/i;
    const timeRegex = /\d{1,2}:\d{2}\s*(AM|PM|am|pm)/i;
    const headers = ['venue','pitch','time','vs','vs:'];
    const BYE_KEYWORD = 'bye';
    let currentDate=null, fixtureState=0, currentFixture={};
    for(const line of lines){
      const dateMatch = line.match(dateRegex);
      if(dateMatch){ currentDate = dateMatch[0]; fixtureState=0; currentFixture={}; continue; }
      if(!currentDate) continue;
      if(headers.includes(line.toLowerCase())) continue;
      switch(fixtureState){
        case 0: currentFixture = { home: line, date: currentDate }; fixtureState=1; break;
        case 1: currentFixture.away = line; fixtureState=2; break;
        case 2: currentFixture.venue = line; fixtureState=3; break;
        case 3: currentFixture.pitch = line; fixtureState=4; break;
        case 4:
          if(line.match(timeRegex)){
            currentFixture.time = line;
            if(currentFixture.home.toLowerCase().includes(BYE_KEYWORD) || currentFixture.away.toLowerCase().includes(BYE_KEYWORD)){
              // skip
            } else {
              const dateObj = new Date(`${currentFixture.date} ${currentFixture.time}`);
              const tempId = crypto.randomUUID();
              fixtures.push({
                ...currentFixture,
                id: tempId,
                dateSortable: isNaN(dateObj.getTime()) ? Date.now() : dateObj.getTime(),
                dateFormatted: isNaN(dateObj.getTime()) ? currentFixture.date : dateFormatter.format(dateObj),
                assignedRef: null,
                volunteers: [], status:'open', isNightShift:false
              });
            }
            fixtureState = 0; currentFixture={};
          }
          break;
      }
    }
    return fixtures;
  };

  // -----------------------------
  // IDENTITY UI
  // -----------------------------
  function updateUIBasedOnIdentity(){
    const display = document.getElementById('identity-display');
    const refForm = document.getElementById('identity-form');
    const adminForm = document.getElementById('admin-login-form');
    const greeting = document.getElementById('ref-greeting');
    const adminPanel = document.getElementById('admin-panel');
    const dbStatus = document.getElementById('db-status-message');
    const loadingText = document.getElementById('loading-text');
    const displayRefName = document.getElementById('display-ref-name');
    const displayRole = document.getElementById('display-role');
    const approvedContainer = document.getElementById('approved-fixtures-container');
    const addFixtureSection = document.getElementById('add-fixture-section');
    const nightAdminControls = document.getElementById('night-shift-admin-controls');

    if(refForm) refForm.classList.add('hidden');
    if(adminForm) adminForm.classList.add('hidden');
    if(display) display.classList.add('hidden');
    if(adminPanel) adminPanel.classList.add('hidden');
    if(addFixtureSection) addFixtureSection.classList.add('hidden');
    if(nightAdminControls) nightAdminControls.classList.add('hidden');

    if(userName){
      if(display) display.classList.remove('hidden');
      if(displayRefName) displayRefName.textContent = userName;
      if(greeting) greeting.textContent = `Welcome, ${userName}. View and manage assignments below.`;
      if(userRole === 'admin'){
        if(displayRole){ displayRole.textContent = 'Administrator'; displayRole.classList.add('text-red-600'); }
        if(approvedContainer) approvedContainer.classList.add('hidden');
        if(adminPanel) adminPanel.classList.remove('hidden');
        if(addFixtureSection) addFixtureSection.classList.remove('hidden');
        if(nightAdminControls) nightAdminControls.classList.remove('block');
        // show admin night controls
        if(nightAdminControls) nightAdminControls.classList.remove('hidden');
      } else {
        if(displayRole){ displayRole.textContent = 'Referee'; displayRole.classList.remove('text-red-600');}
        if(approvedContainer) approvedContainer.classList.remove('hidden');
      }
    } else {
      if(refForm) refForm.classList.remove('hidden');
      if(greeting) greeting.textContent = 'Please log in to view the schedule.';
      if(approvedContainer) approvedContainer.classList.add('hidden');
      userRole = 'none';
    }

    if(loadingText){
      if(!isDbReady) loadingText.innerHTML = '‚ö†Ô∏è Using local storage. Data is NOT persistent or shared.';
      else if(!userName) loadingText.textContent = 'Please log in to load the schedule.';
    }
  }

  window.showAdminLoginForm = function(){ document.getElementById('identity-form')?.classList.add('hidden'); document.getElementById('admin-login-form')?.classList.remove('hidden'); }
  window.showRefereeLoginForm = function(){ document.getElementById('admin-login-form')?.classList.add('hidden'); document.getElementById('identity-form')?.classList.remove('hidden'); }

  window.handleRefereeLogin = function(){
    const input = document.getElementById('referee-name-input');
    const name = input?.value?.trim();
    if(!name) return showStatus('danger','Please enter your full name.');
    userId = name.toLowerCase().replace(/\s/g,'-');
    userName = name; userRole = 'referee';
    if(auth){
      signInAnonymously(auth).then(()=>{ updateUIBasedOnIdentity(); if(input) input.value=''; showStatus('success',`Welcome ${userName}!`); setupDataListener(); })
      .catch(e=>{ console.error(e); showStatus('danger','Auth failed'); updateUIBasedOnIdentity(); setupDataListener(); });
    } else {
      updateUIBasedOnIdentity(); if(input) input.value=''; showStatus('warning','Welcome ‚Äî Firebase initializing.'); setupDataListener();
    }
  };

  window.handleAdminLogin = function(){
    const email = document.getElementById('admin-email')?.value.trim();
    const pass = document.getElementById('admin-password')?.value.trim();
    if(email === ADMIN_EMAIL && pass === ADMIN_PASSWORD){
      userId = 'ADMIN-USER-ID'; userName = ADMIN_NAME; userRole = 'admin';
      updateUIBasedOnIdentity();
      showStatus(isDbReady ? 'success' : 'warning', isDbReady ? 'Admin login successful. Database ready.' : 'Admin login successful. Using local fallback.');
      document.getElementById('admin-panel-details')?.classList.remove('hidden');
      document.getElementById('admin-toggle-icon').textContent = '‚àí';
      setupDataListener();
    } else showStatus('danger','Invalid admin credentials.');
  };

  window.clearIdentity = function(){
    userId = userName = ''; userRole = 'none';
    if(auth && auth.signOut) auth.signOut();
    updateUIBasedOnIdentity(); showStatus('warning','Logged out.'); setupDataListener();
  };

  // COLLAPSE PANEL
  function toggleControlPanel(){
    const panel = document.getElementById('user-control-panel');
    const content = document.getElementById('panel-content');
    const btn = document.getElementById('collapse-panel-btn');
    if(panel.classList.contains('panel-collapsed')){
      panel.classList.remove('panel-collapsed');
      content.classList.remove('collapsed-hide');
      btn.textContent = '‚ñ≤';
    } else {
      panel.classList.add('panel-collapsed');
      content.classList.add('collapsed-hide');
      btn.textContent = '‚ñº';
    }
  }

  // -----------------------------
  // FIREBASE INIT
  // -----------------------------
  async function initFirebase(){
    const loadingText = document.getElementById('loading-text');
    if(!rawFirebaseConfig || !rawFirebaseConfig.projectId){ isDbReady = false; updateUIBasedOnIdentity(); setupDataListener(); if(loadingText) loadingText.innerHTML='‚ùå ERROR: Firebase config missing. Using local storage.'; return; }
    try {
      app = initializeApp(rawFirebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      isDbReady = true;
      if(initialAuthToken){ await signInWithCustomToken(auth, initialAuthToken); } else { await signInAnonymously(auth); }
      onAuthStateChanged(auth, (user)=>{ if(user) setupDataListener(); });
      updateUIBasedOnIdentity();
    } catch(e){ console.error('firebase init', e); isDbReady=false; showStatus('danger','Firebase failed ‚Äî using local storage.'); updateUIBasedOnIdentity(); setupDataListener(); }
  }

  // -----------------------------
  // MERGE NIGHT SHIFTS WITH DYNAMIC STATE
  // -----------------------------
  function mergeNightShifts(dynamicFixtures){
    const dynamicMap = new Map();
    const weeklyFixtures = [];
    dynamicFixtures.forEach(f=>{
      const isNight = NIGHT_SHIFTS.some(n=>n.id===f.id);
      if(isNight) dynamicMap.set(f.id,f); else weeklyFixtures.push(f);
    });

    const merged = [];
    NIGHT_SHIFTS.forEach(staticShift=>{
      const copy = { ...staticShift, volunteers:[], assignedRef:null, status:'open', hiddenThisWeek:false };
      const dyn = dynamicMap.get(staticShift.id);
      if(dyn) Object.assign(copy, dyn);
      merged.push(copy);
    });
    merged.push(...weeklyFixtures);
    return merged;
  }

  // -----------------------------
  // LOAD / LISTENER
  // -----------------------------
  function setupDataListener(){
    const loadingIndicator = document.getElementById('loading-indicator');
    if(loadingIndicator) loadingIndicator.classList.remove('hidden');

    // Local-only path (or fallback)
    if(!isDbReady || !db){
      // If no saved fixtures, start clean with just night shift static definitions
      const local = loadFixturesLocal();
      // Only include local weekly fixtures if present; otherwise keep only night shift static definitions
      const hasWeekly = local.some(f => !f.isNightShift);
      const base = hasWeekly ? local : []; // if no weekly, don't pre-populate
      const all = mergeNightShifts(base);
      all.sort((a,b) => (a.dateSortable||0) - (b.dateSortable||0));
      if(loadingIndicator) loadingIndicator.classList.add('hidden');
      renderAll(all);
      return;
    }

    // Firebase live path
    const fixturesRef = collection(db, FIRES_COLLECTION_PATH);
    const q = query(fixturesRef);
    onSnapshot(q, (snapshot)=>{
      const dyn = [];
      snapshot.forEach(docSnap => { dyn.push({ id: docSnap.id, ...docSnap.data() }); });
      const all = mergeNightShifts(dyn);
      all.sort((a,b)=> (a.dateSortable||0) - (b.dateSortable||0));
      if(loadingIndicator) loadingIndicator.classList.add('hidden');
      renderAll(all);
    }, (err)=>{
      console.error('firestore listen', err);
      isDbReady = false;
      setupDataListener();
      showStatus('danger','Error fetching live schedule. Using local storage.');
    });
  }

  // -----------------------------
  // RENDERING: Night Shifts + Fixtures
  // -----------------------------
  function renderNightShifts(allFixtures){
    const container = document.getElementById('night-shifts-container'); if(!container) return;
    container.innerHTML = '';

    const nightOnly = allFixtures.filter(f => f.isNightShift);
    let anyHidden = false;
    nightOnly.forEach(shift=>{
      if(shift.hiddenThisWeek) anyHidden = true;
      // Admin sees hidden shifts (faded) ‚Äî refs don't see hidden ones
      if(shift.hiddenThisWeek && userRole !== 'admin') return;

      const card = document.createElement('div');
      card.className = `nightshift-card bg-white rounded-xl shadow-md p-3 flex flex-col justify-between ${shift.hiddenThisWeek ? 'faded' : ''}`;
      card.setAttribute('data-id', shift.id);
      card.innerHTML = `
        <div class="flex justify-between items-start">
          <div>
            <p class="text-sm font-semibold text-gray-900">${shift.venue}</p>
            <p class="text-xs text-gray-500">${shift.pitch} ‚Ä¢ ${shift.format || ''}</p>
          </div>
          <div class="text-right text-xs">
            ${shift.assignedRef ? `<div class="text-sm font-bold text-green-700">Assigned</div><div class="text-xs">${shift.assignedRef}</div>` : `<div class="text-sm font-semibold text-red-600">${(shift.volunteers||[]).length} Volunteers</div>`}
          </div>
        </div>
        <div class="mt-3 flex justify-between items-center">
          <div class="text-xs text-gray-500">Night Shift</div>
          <div class="flex gap-2 items-center">
            ${userRole==='admin' ? `<button onclick="event.stopPropagation(); hideNightShift('${shift.id}')" class="text-xs text-gray-600 hover:text-red-600">üóëÔ∏è Hide</button>` : ''}
            ${userRole==='referee' ? `<button onclick="event.stopPropagation(); handleVolunteer(null,'${shift.id}', true)" class="px-2 py-1 text-xs bg-indigo-600 text-white rounded">Apply</button>` : ''}
          </div>
        </div>
      `;
      container.appendChild(card);
    });

    // show restore hidden button only if one or more hidden and admin logged in
    const restoreBtn = document.getElementById('restore-hidden-btn');
    if(restoreBtn){
      const hasHidden = nightOnly.some(n => n.hiddenThisWeek);
      if(userRole==='admin' && hasHidden) restoreBtn.classList.remove('hidden'); else restoreBtn.classList.add('hidden');
    }
  }

  function renderAll(allFixtures){
    // night shifts first
    renderNightShifts(allFixtures);

    // approved list rendering (for refs)
    const approvedListContainer = document.getElementById('approved-fixtures-list');
    const approvedContainer = document.getElementById('approved-fixtures-container');
    const now = Date.now();
    if(approvedListContainer && approvedContainer){
      if(userName && userRole==='referee'){
        approvedContainer.classList.remove('hidden');
        approvedListContainer.innerHTML = '';
        const approved = allFixtures.filter(f => f.assignedRef === userName && (f.dateSortable >= now || f.isNightShift)).sort((a,b)=> (a.dateSortable||0)-(b.dateSortable||0));
        if(approved.length){
          approved.forEach(f=>{
            const card = document.createElement('div');
            card.className = 'fixture-card rounded-xl shadow-md overflow-hidden bg-green-100 border-l-4 border-green-700';
            card.innerHTML = `<div class="fixture-main-content">
              <div class="flex flex-col flex-shrink-0 w-16 text-center">
                <span class="text-lg font-bold text-gray-900 leading-none">${f.time||''}</span>
                <span class="text-xs font-medium text-gray-500 hidden sm:block">${f.dateFormatted||''}</span>
              </div>
              <div class="flex-grow min-w-0 pr-4">
                <p class="text-base font-semibold text-gray-900 truncate">${f.home} vs ${f.away}</p>
                <p class="text-xs text-green-700 font-bold">ASSIGNED</p>
              </div>
              <div class="flex flex-col flex-shrink-0 w-24 text-right">
                <span class="text-sm font-semibold text-gray-700 truncate">${f.venue||''}</span>
                <span class="text-xs font-medium text-red-600">Pitch ${f.pitch||''}</span>
              </div>
            </div>
            <div class="fixture-action-area bg-green-200 text-center text-sm font-bold text-green-800">CONFIRMED</div>`;
            approvedListContainer.appendChild(card);
          });
        } else approvedListContainer.innerHTML = `<p class="text-center py-4 text-gray-500">You have no approved assignments yet.</p>`;
      } else approvedContainer.classList.add('hidden');
    }

    // Now render weekly fixtures only (exclude night shifts entirely from the list)
    const upcomingList = document.getElementById('upcoming-fixtures-list');
    if(!upcomingList) return;
    upcomingList.innerHTML = '';

    let groupedDate = null;
    let fixtureFound = false;

    const weeklyFixtures = allFixtures.filter(f => !f.isNightShift && !f.hiddenThisWeek);
    weeklyFixtures.sort((a,b)=> (a.dateSortable||0)-(b.dateSortable||0));

    weeklyFixtures.forEach(fixture => {
      if(!fixture.home || !fixture.away) return;
      // skip past if older than now
      if(fixture.dateSortable && fixture.dateSortable < Date.now()) return;
      fixtureFound = true;
      const dateHeaderKey = fixture.dateFormatted || (new Date(fixture.dateSortable||Date.now())).toDateString();
      if(dateHeaderKey !== groupedDate){
        groupedDate = dateHeaderKey;
        const header = document.createElement('h3');
        header.className = "text-xl font-bold text-gray-800 mt-6 mb-3 p-2 bg-gray-200 rounded-lg shadow-inner";
        header.textContent = groupedDate;
        upcomingList.appendChild(header);
      }

      const card = document.createElement('div');
      card.className = 'fixture-card rounded-xl shadow-md overflow-hidden transition duration-300 bg-white border-l-4 border-red-500';
      card.setAttribute('data-id', fixture.id);

      // prepare status and actions
      const volunteerCount = (fixture.volunteers||[]).length;
      const isVolunteer = userName && (fixture.volunteers||[]).includes(userName);

      let statusBadge = '';
      if(fixture.status === 'assigned') statusBadge = `<span class="text-sm font-bold text-green-700">ASSIGNED</span>`;
      else if(isVolunteer) statusBadge = `<span class="text-sm font-bold text-yellow-700">APPLIED</span>`;
      else statusBadge = `<span class="text-sm font-bold text-red-700">OPEN (${volunteerCount})</span>`;

      // if admin and editing for this id -> render inputs
      if(userRole === 'admin' && editingIds.has(fixture.id)){
        const dateVal = fixture.dateSortable ? new Date(fixture.dateSortable) : null;
        const isoDate = dateVal ? dateVal.toISOString().slice(0,10) : '';
        const timeVal = fixture.time ? convertTimeTo24(fixture.time) : '';
        card.innerHTML = `
          <div class="fixture-main-content">
            <div class="flex flex-col flex-shrink-0 w-16 text-center">
              <input id="edit-date-${fixture.id}" type="date" value="${isoDate}" class="p-1 text-sm border rounded"/>
              <input id="edit-time-${fixture.id}" type="time" value="${timeVal}" class="p-1 text-sm border rounded mt-1"/>
            </div>
            <div class="flex-grow min-w-0 pr-4">
              <input id="edit-home-${fixture.id}" class="w-full p-1 border rounded mb-1 text-sm" value="${escapeHtml(fixture.home||'')}" />
              <input id="edit-away-${fixture.id}" class="w-full p-1 border rounded text-sm" value="${escapeHtml(fixture.away||'')}" />
            </div>
            <div class="flex flex-col flex-shrink-0 w-24 text-right">
              <input id="edit-venue-${fixture.id}" class="w-full text-sm p-1 border rounded mb-1" value="${escapeHtml(fixture.venue||'')}" />
              <input id="edit-pitch-${fixture.id}" class="w-full text-xs p-1 border rounded" value="${escapeHtml(fixture.pitch||'')}" />
            </div>
            <div class="flex-shrink-0 block sm:hidden">${statusBadge}</div>
          </div>
          <div class="fixture-action-area flex items-center justify-between">
            <div class="text-xs text-gray-500">Editing</div>
            <div class="flex gap-2">
              <button onclick="event.stopPropagation(); saveEdit('${fixture.id}')" class="px-2 py-1 text-xs bg-green-600 text-white rounded">üíæ Save</button>
              <button onclick="event.stopPropagation(); cancelEdit('${fixture.id}')" class="px-2 py-1 text-xs border rounded">Cancel</button>
              <button onclick="event.stopPropagation(); permanentlyDeleteFixture('${fixture.id}')" class="px-2 py-1 text-xs text-red-600 hover:text-red-800">‚ùå Delete</button>
            </div>
          </div>
        `;
      } else {
        // regular display for card
        card.innerHTML = `
          <div class="fixture-main-content">
            <div class="flex flex-col flex-shrink-0 w-16 text-center">
              <span class="text-lg font-bold text-gray-900 leading-none">${fixture.time||''}</span>
              <span class="text-xs font-medium text-gray-500 hidden sm:block">${fixture.dateFormatted||''}</span>
            </div>
            <div class="flex-grow min-w-0 pr-4">
              <p class="text-base font-semibold text-gray-900 truncate">${fixture.home} vs ${fixture.away}</p>
            </div>
            <div class="flex flex-col flex-shrink-0 w-24 text-right">
              <span class="text-sm font-semibold text-gray-700 truncate">${fixture.venue||''}</span>
              <span class="text-xs font-medium text-red-600">Pitch ${fixture.pitch||''}</span>
            </div>
            <div class="flex-shrink-0 block sm:hidden">${statusBadge}</div>
          </div>
          <div class="fixture-action-area">
            <div class="flex items-center justify-between">
              <div>
                ${renderActionHtmlForUser(fixture)}
              </div>
              <div class="flex gap-2">
                ${userRole==='admin' ? `<button onclick="event.stopPropagation(); startEdit('${fixture.id}')" class="px-2 py-1 text-xs bg-indigo-600 text-white rounded">‚úèÔ∏è Edit</button>
                <button onclick="event.stopPropagation(); permanentlyDeleteFixture('${fixture.id}')" class="px-2 py-1 text-xs text-red-600 hover:text-red-800">‚ùå Delete</button>` : ''}
              </div>
            </div>
          </div>
        `;
      }

      upcomingList.appendChild(card);
    });

    if(!fixtureFound){
      const li = document.createElement('p');
      li.className = 'text-center py-10 text-gray-500';
      li.textContent = userName ? 'No weekly fixtures have been loaded. Only Night Shifts are available.' : 'No upcoming fixtures. Admin needs to load the schedule.';
      upcomingList.appendChild(li);
    }
  }

  // Helper to build action area depending on role
  function renderActionHtmlForUser(fixture){
    const volunteerCount = (fixture.volunteers||[]).length;
    const isVolunteer = userName && (fixture.volunteers||[]).includes(userName);
    if(userRole === 'admin'){
      if(fixture.status === 'assigned'){
        return `<div class="p-2 text-center text-xs space-y-1">
            <p class="font-bold text-green-600 truncate">${fixture.assignedRef}</p>
            <button onclick="event.stopPropagation(); handleUnassign('${fixture.id}')" class="text-xs text-red-500 hover:text-red-700 underline">Clear</button>
          </div>`;
      } else {
        return `<div class="p-2 text-center text-sm">
            <span class="font-bold text-red-600">${volunteerCount} <span class="hidden sm:inline">Volunteer(s)</span></span>
            <p class="text-xs text-gray-500 mt-1">Click to Assign</p>
          </div>`;
      }
    } else if(userRole === 'referee'){
      if(fixture.status === 'assigned' && fixture.assignedRef === userName){
        return `<div class="p-2 text-center text-sm text-green-600 font-bold">ASSIGNED</div>`;
      } else if(fixture.status === 'assigned' && fixture.assignedRef !== userName){
        return `<div class="p-2 text-center text-sm text-gray-600 font-bold">Assigned to: ${fixture.assignedRef}</div>`;
      } else {
        const actionClass = isVolunteer ? 'bg-red-500 hover:bg-red-600' : 'bg-indigo-600 hover:bg-indigo-700';
        const actionText = isVolunteer ? 'Cancel Application' : 'Apply Now';
        const actionState = isVolunteer ? 'false' : 'true';
        return `<button onclick="handleVolunteer(event,'${fixture.id}', ${actionState})" class="w-full h-full text-white p-2 font-semibold text-sm ${actionClass} transition duration-150">${actionText}</button>`;
      }
    } else {
      return `<div class="p-2 text-center text-sm text-gray-500">${fixture.status==='assigned' ? 'Assigned' : 'Login to Apply'}</div>`;
    }
  }

  // -----------------------------
  // HELPERS: convert time formats, escape HTML
  // -----------------------------
  function convertTimeTo24(timeStr){
    if(!timeStr) return '';
    // Accept "7:00 PM" style or "19:00"
    const pmRegex = /(\d{1,2}):(\d{2})\s*(AM|PM|am|pm)/;
    const m = timeStr.match(pmRegex);
    if(m){
      let h = parseInt(m[1],10), min = m[2], ap = m[3].toLowerCase();
      if(ap==='pm' && h<12) h += 12;
      if(ap==='am' && h===12) h = 0;
      return `${String(h).padStart(2,'0')}:${min}`;
    }
    // assume already 24h
    return timeStr;
  }
  function formatTimeFromInputs(hoursMinutes){
    // returns "7:00 PM" style
    if(!hoursMinutes) return '';
    const [h,m] = hoursMinutes.split(':').map(Number);
    if(isNaN(h)) return '';
    const ap = h>=12 ? 'PM' : 'AM';
    const hh = ((h+11)%12+1);
    return `${hh}:${String(m).padStart(2,'0')} ${ap}`;
  }
  function escapeHtml(s){ return (s||'').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

  // -----------------------------
  // VOLUNTEER / ASSIGN / UNASSIGN
  // -----------------------------
  window.openAssignmentModal = function(matchId, home, away, date, time, volunteersJson, assignedRef){
    if(userRole !== 'admin') return;
    let volunteers=[];
    try{ volunteers = JSON.parse(volunteersJson.replace(/\\'/g,"'")); } catch(e){ volunteers = []; }
    const modal = document.getElementById('admin-assignment-modal-backdrop');
    const title = document.getElementById('modal-match-title');
    const details = document.getElementById('modal-match-details');
    const listContainer = document.getElementById('volunteer-list-container');
    const matchIdInput = document.getElementById('modal-match-id');
    const assignBtn = document.getElementById('assign-button');
    if(!modal || !title || !details || !listContainer || !matchIdInput || !assignBtn) return;
    title.textContent = `${home} vs ${away}`;
    details.textContent = `${date} at ${time}`;
    matchIdInput.value = matchId;
    listContainer.innerHTML = '';
    if(assignedRef){ listContainer.innerHTML = `<p class="font-bold text-green-600">Currently Assigned: ${assignedRef}</p>`; assignBtn.disabled=true; assignBtn.textContent='Already Assigned'; }
    else if(volunteers.length===0){ listContainer.innerHTML = '<p class="text-sm text-gray-600">No referees have volunteered yet.</p>'; assignBtn.disabled=true; assignBtn.textContent='No Volunteers'; }
    else {
      volunteers.forEach(n=>{
        const safe = n.replace(/[^a-z0-9]/gi,'_');
        const id = `ref-${safe}`;
        listContainer.innerHTML += `<label for="${id}" class="flex items-center p-2 bg-white rounded-lg cursor-pointer hover:bg-red-50 transition">
          <input type="radio" id="${id}" name="selected_ref" value="${n}" class="text-red-600 focus:ring-red-500 h-4 w-4" />
          <span class="ml-3 font-medium text-gray-900">${n}</span>
        </label>`;
      });
      assignBtn.disabled=true; assignBtn.textContent='Confirm Assignment';
      document.querySelectorAll('input[name="selected_ref"]').forEach(r=>r.addEventListener('change',()=>assignBtn.disabled=false));
    }
    modal.classList.add('show'); modal.style.display='flex';
  };
  window.closeAssignmentModal = function(){ const modal=document.getElementById('admin-assignment-modal-backdrop'); if(!modal) return; modal.classList.remove('show'); setTimeout(()=>modal.style.display='none',300); };

  window.handleFinalAssignment = async function(){
    if(userRole!=='admin') return showStatus('danger','Only administrators can make assignments.');
    const matchId = document.getElementById('modal-match-id')?.value;
    const selected = document.querySelector('input[name="selected_ref"]:checked');
    if(!matchId || !selected) return showStatus('warning','Missing information');
    const target = selected.value;

    if(isDbReady && db){
      try{
        const refDoc = doc(db, FIRES_COLLECTION_PATH, matchId);
        await updateDoc(refDoc, { assignedRef: target, status:'assigned', updatedAt: serverTimestamp() });
        closeAssignmentModal(); showStatus('success','Assigned in database.');
        return;
      } catch(e){ console.error('assign db',e); isDbReady=false; showStatus('danger','DB failed; falling back local'); }
    }

    // local fallback
    updateLocalFixture(matchId, { assignedRef: target, status:'assigned', updatedAt: Date.now() });
    closeAssignmentModal(); showStatus('success','Assigned locally.');
  };

  window.handleVolunteer = async function(event, matchId, isVolunteering){
    if(event && event.stopPropagation) event.stopPropagation();
    if(!userName || userRole!=='referee') return showStatus('danger','Please log in as a Referee first.');

    if(isDbReady && db){
      try{
        const refDoc = doc(db, FIRES_COLLECTION_PATH, matchId);
        const action = isVolunteering ? arrayUnion(userName) : arrayRemove(userName);
        await updateDoc(refDoc, { volunteers: action, updatedAt: serverTimestamp(), status:'open' });
        return showStatus('success', isVolunteering ? `‚úÖ ${userName}, you have applied!` : 'Cancelled');
      } catch(e){ console.error('vol db',e); isDbReady=false; showStatus('danger','DB failed; falling back local'); }
    }

    // local fallback
    const fixtures = loadFixturesLocal();
    const i = fixtures.findIndex(f => f.id === matchId);
    if(i>=0){
      const cur = fixtures[i].volunteers || [];
      if(isVolunteering){
        if(!cur.includes(userName)) cur.push(userName);
      } else {
        fixtures[i].volunteers = cur.filter(n=>n!==userName);
      }
      saveFixturesLocal(fixtures);
      renderAll(mergeNightShifts(fixtures));
      return showStatus('success', isVolunteering ? 'Applied locally.' : 'Cancelled locally.');
    } else {
      // might be a night shift not yet in local
      updateLocalFixture(matchId, { volunteers: isVolunteering ? [userName] : [], assignedRef:null, status:'open' });
      return showStatus('success', isVolunteering ? 'Applied (local).' : 'Cancelled local');
    }
  };

  window.handleUnassign = async function(matchId){
    if(userRole!=='admin') return showStatus('danger','Only administrators can unassign.');
    if(isDbReady && db){
      try{ const refDoc = doc(db, FIRES_COLLECTION_PATH, matchId); await updateDoc(refDoc, { assignedRef:null, status:'open', updatedAt: serverTimestamp() }); return showStatus('warning','Assignment cleared (db)'); } catch(e){ console.error('unassign db',e); isDbReady=false; showStatus('danger','DB failed; falling back local'); }
    }
    updateLocalFixture(matchId, { assignedRef:null, status:'open', updatedAt: Date.now() });
    showStatus('warning','Assignment cleared (local).');
  };

  // -----------------------------
  // UPDATE LOCAL FIXTURE (helper)
  // -----------------------------
  function updateLocalFixture(matchId, updates){
    const fixtures = loadFixturesLocal();
    const idx = fixtures.findIndex(f => f.id === matchId);
    if(idx !== -1){ fixtures[idx] = { ...fixtures[idx], ...updates }; }
    else {
      // if it's night shift, push merged
      const staticS = NIGHT_SHIFTS.find(s => s.id === matchId);
      if(staticS) fixtures.push({ ...staticS, ...updates });
      else fixtures.push({ id:matchId, ...updates });
    }
    saveFixturesLocal(fixtures);
    renderAll(mergeNightShifts(fixtures));
  }

  // -----------------------------
  // INLINE EDIT CONTROLS (start/cancel/save/delete)
  // -----------------------------
  window.startEdit = function(matchId){ editingIds.add(matchId); if(!isDbReady||!db) renderAll(mergeNightShifts(loadFixturesLocal())); else setupDataListener(); };
  window.cancelEdit = function(matchId){ editingIds.delete(matchId); if(!isDbReady||!db) renderAll(mergeNightShifts(loadFixturesLocal())); else setupDataListener(); };

  window.saveEdit = async function(matchId){
    const dateInput = document.getElementById(`edit-date-${matchId}`)?.value;
    const timeInput = document.getElementById(`edit-time-${matchId}`)?.value;
    const home = document.getElementById(`edit-home-${matchId}`)?.value || '';
    const away = document.getElementById(`edit-away-${matchId}`)?.value || '';
    const venue = document.getElementById(`edit-venue-${matchId}`)?.value || '';
    const pitch = document.getElementById(`edit-pitch-${matchId}`)?.value || '';

    // compute dateSortable and dateFormatted
    let dateSortable = 0, dateFormatted = '';
    if(dateInput){
      try {
        const dt = new Date(`${dateInput}T${timeInput || '00:00'}`);
        if(!isNaN(dt.getTime())){ dateSortable = dt.getTime(); dateFormatted = dateFormatter.format(dt); }
      } catch(e){ console.warn('date parse', e); }
    }

    const updates = {
      home, away, venue, pitch, time: formatTimeFromInputs(timeInput),
      dateSortable: dateSortable || undefined,
      dateFormatted: dateFormatted || undefined,
      updatedAt: Date.now()
    };

    if(isDbReady && db){
      try{
        const refDoc = doc(db, FIRES_COLLECTION_PATH, matchId);
        // avoid setting undefined values in Firestore
        const cleaned = {};
        Object.keys(updates).forEach(k => { if(updates[k]!==undefined) cleaned[k]=updates[k]; });
        await updateDoc(refDoc, cleaned);
        editingIds.delete(matchId); showStatus('success','Fixture updated (db)'); return;
      } catch(e){ console.error('save edit db',e); isDbReady=false; showStatus('danger','DB failed; falling back local'); }
    }

    // local fallback
    const fixtures = loadFixturesLocal();
    const idx = fixtures.findIndex(f => f.id === matchId);
    if(idx>=0){
      fixtures[idx] = { ...fixtures[idx], ...updates };
    } else {
      fixtures.push({ id:matchId, ...updates, volunteers:[], assignedRef:null, status:'open' });
    }
    saveFixturesLocal(fixtures);
    editingIds.delete(matchId);
    renderAll(mergeNightShifts(fixtures));
    showStatus('success','Fixture updated locally.');
  };

  window.permanentlyDeleteFixture = async function(matchId){
    if(userRole!=='admin') return showStatus('danger','Only administrators can delete fixtures.');
    const isNight = NIGHT_SHIFTS.some(s=>s.id===matchId);
    if(isNight){
      // for night shifts, delete acts as hide for the week
      return hideNightShift(matchId);
    }
    if(isDbReady && db){
      try{
        const refDoc = doc(db, FIRES_COLLECTION_PATH, matchId);
        await deleteDoc(refDoc);
        showStatus('warning','Fixture permanently deleted (db).'); return;
      } catch(e){ console.error('delete db',e); isDbReady=false; showStatus('danger','DB delete failed; falling back local'); }
    }
    // local removal
    const fixtures = loadFixturesLocal().filter(f=>f.id!==matchId);
    saveFixturesLocal(fixtures);
    renderAll(mergeNightShifts(fixtures));
    showStatus('warning','Fixture permanently removed (local).');
  };

  // -----------------------------
  // ADD FIXTURE INLINE (save & clear)
  // -----------------------------
  window.toggleAddFixtureForm = function(show){
    const form = document.getElementById('add-fixture-form');
    if(!form) return;
    form.classList.toggle('hidden', !show);
  };

  window.handleAddFixture = async function(){
    if(userRole!=='admin') return showStatus('danger','Only administrators can add fixtures.');
    const dateVal = document.getElementById('new-fixture-date')?.value;
    const timeVal = document.getElementById('new-fixture-time')?.value;
    const venue = document.getElementById('new-fixture-venue')?.value?.trim();
    const home = document.getElementById('new-fixture-home')?.value?.trim();
    const away = document.getElementById('new-fixture-away')?.value?.trim();
    const pitch = document.getElementById('new-fixture-pitch')?.value?.trim();
    if(!dateVal || !timeVal || !home || !away || !venue) return showStatus('danger','Fill date/time/home/away/venue');

    const dt = new Date(`${dateVal}T${timeVal}`);
    const newFixture = {
      id: crypto.randomUUID(),
      home, away, venue, pitch, time: formatTimeFromInputs(timeVal),
      dateSortable: isNaN(dt.getTime()) ? Date.now() : dt.getTime(),
      dateFormatted: isNaN(dt.getTime()) ? dateVal : dateFormatter.format(dt),
      assignedRef:null, volunteers:[], status:'open', isNightShift:false, createdAt: Date.now(), updatedAt: Date.now()
    };

    if(isDbReady && db){
      try{
        const col = collection(db, FIRES_COLLECTION_PATH);
        const docRef = await addDoc(col, { ...newFixture, id: undefined, createdAt: serverTimestamp(), updatedAt: serverTimestamp() });
        // set the doc to include its firestore id
        await updateDoc(doc(db, FIRES_COLLECTION_PATH, docRef.id), { id: docRef.id });
        showStatus('success','Fixture added to database.');
        toggleAddFixtureForm(false);
        // clear fields
        ['new-fixture-date','new-fixture-time','new-fixture-venue','new-fixture-home','new-fixture-away','new-fixture-pitch'].forEach(id=>document.getElementById(id).value='');
        return;
      } catch(e){ console.error('add db',e); isDbReady=false; showStatus('danger','DB failed; falling back local'); }
    }

    const existing = loadFixturesLocal(); existing.push(newFixture); saveFixturesLocal(existing);
    toggleAddFixtureForm(false);
    ['new-fixture-date','new-fixture-time','new-fixture-venue','new-fixture-home','new-fixture-away','new-fixture-pitch'].forEach(id=>document.getElementById(id).value='');
    renderAll(mergeNightShifts(existing));
    showStatus('success','Fixture added locally.');
  };

  // -----------------------------
  // NIGHT SHIFT HIDE & RESTORE
  // -----------------------------
  window.hideNightShift = async function(shiftId){
    if(userRole!=='admin') return showStatus('danger','Only admin can hide night shifts.');
    // DB path
    if(isDbReady && db){
      try{
        const refDoc = doc(db, FIRES_COLLECTION_PATH, shiftId);
        await updateDoc(refDoc, { hiddenThisWeek:true, updatedAt: serverTimestamp() });
        showStatus('warning','Night shift hidden (db).');
        return;
      } catch(e){ console.error('hide db',e); isDbReady=false; showStatus('danger','DB failed; falling back local'); }
    }
    // local fallback: mark hidden
    updateLocalFixture(shiftId, { hiddenThisWeek:true, updatedAt: Date.now() });
    // visual: immediate fade and remove for non-admins (we re-render)
    const el = document.querySelector(`[data-id="${shiftId}"]`);
    if(el){ el.classList.add('faded'); setTimeout(()=>{ renderAll(mergeNightShifts(loadFixturesLocal())); },350); }
    showStatus('warning','Night shift hidden for this week (local).');
  };

  window.restoreHiddenNightShifts = async function(){
    if(userRole!=='admin') return showStatus('danger','Only admin can restore.');
    // DB path
    if(isDbReady && db){
      try{
        // naive approach: load local/remote, remove hiddenThisWeek on known night shift docs
        const allLocal = loadFixturesLocal();
        const updated = allLocal.map(f=> ({ ...f, hiddenThisWeek: false }));
        saveFixturesLocal(updated);
        // Note: to restore DB entries we'd need to fetch each night shift doc and update; for simplicity, we remove the hidden flag from local store and attempt to update DB for any matching docs
        const col = collection(db, FIRES_COLLECTION_PATH);
        const snapshot = await getDocs(query(col));
        snapshot.forEach(async d => {
          if(NIGHT_SHIFTS.some(n=>n.id===d.id || n.id===d.data().id)) {
            try{ await updateDoc(doc(db, FIRES_COLLECTION_PATH, d.id), { hiddenThisWeek:false, updatedAt: serverTimestamp() }); } catch(e){}
          }
        });
        showStatus('success','Hidden night shifts restored (db+local).');
        renderAll(mergeNightShifts(updated));
        return;
      } catch(e){ console.error('restore db',e); isDbReady=false; showStatus('danger','DB restore failed; falling back local'); }
    }
    // local only
    const fixtures = loadFixturesLocal().map(f => ({ ...f, hiddenThisWeek:false }));
    saveFixturesLocal(fixtures);
    renderAll(mergeNightShifts(fixtures));
    showStatus('success','Hidden night shifts restored (local).');
  };

  // -----------------------------
  // STARTUP
  // -----------------------------
  function startApp(){ updateUIBasedOnIdentity(); initFirebase(); }
  startApp();

  </script>
</body>
</html>
